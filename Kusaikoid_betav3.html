<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kusaikoid ver.beta5.0</title>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      height: 100vh;
      align-items: flex-start;
      background-color: #fafafa;
    }
    #sidebarToggle {
      position: fixed;
      top: 1rem;
      left: 1rem;
      background: #333;
      color: white;
      padding: 0.75rem 1rem;
      cursor: pointer;
      z-index: 1001;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: background 0.2s ease;
    }
    
    #sidebarToggle:hover {
      background: #555;
    }
    
    #sidebar {
      width: 340px;
      background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
      padding: 1rem 1.25rem;
      box-shadow: 3px 0 20px rgba(0,0,0,0.15);
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow-y: auto;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 1000;
      border-right: 1px solid #e0e0e0;
      backdrop-filter: blur(10px);
    }
    /* #sidebar.bottom { ä¸‹è¡¨ç¤ºã¯ç„¡åŠ¹åŒ–ï¼ˆå¸¸ã«å·¦å›ºå®šï¼‰ } */
    #sidebar.closed {
      transform: translateX(-100%);
    }
    
    #main {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      margin-left: 355px; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å¹…åˆ†ã ã‘å³ã«ãšã‚‰ã™ï¼ˆé–‹æ™‚ï¼‰ */
      transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: #ffffff;
      min-height: 100vh;
    }
    
    #sidebar.closed ~ #main {
      margin-left: 0 !important; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‰æ™‚ã¯å·¦å¯„ã› */
    }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®æœ€é©åŒ– */
    textarea, select, input {
      margin-bottom: 0.75rem;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-family: inherit;
      font-size: 0.9rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }
    
    textarea:focus, select:focus, input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }
    
    textarea {
      width: 100%;
      resize: vertical;
      line-height: 1.5;
    }
    
    select {
      min-width: 150px;
      cursor: pointer;
    }
    
    /* ãƒœã‚¿ãƒ³ã®çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ« */
    button {
      padding: 0.75rem 1rem;
      margin-right: 0.5rem;
      border: none;
      border-radius: 6px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    button:hover {
      background-color: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }
    
    button:active {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(0, 123, 255, 0.3);
    }

    /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ“ä½œãƒœã‚¿ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .segment-container {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: #ffffff;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: all 0.2s ease;
      position: relative;
    }
    
    .segment-container:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: #007bff;
    }
    
    .segment-container[data-edited="true"]::before {
      content: "ç·¨é›†æ¸ˆã¿";
      position: absolute;
      top: -8px;
      right: 8px;
      background: #28a745;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .segment-textarea {
      width: 100%;
      resize: vertical;
      min-height: 60px;
      margin-bottom: 0.75rem;
    }
    
    .segment-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
    }
    
    .control-group {
      display: flex;
      gap: 0.25rem;
      align-items: center;
    }
    
    .control-group--play {
      margin-right: auto;
    }
    
    .control-group--history .btn {
      min-width: 32px;
      padding: 0.4rem 0.6rem;
      font-size: 0.9rem;
    }
    
    .control-group--voice select {
      font-size: 0.8rem;
      padding: 0.4rem 0.6rem;
    }
    
    .control-group--actions .btn {
      font-size: 0.8rem;
      padding: 0.4rem 0.6rem;
    }
    
    .btn {
      background-color: #f8f9fa;
      color: #495057;
      border: 1px solid #dee2e6;
      padding: 0.5rem;
      font-size: 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 36px;
    }
    
    .btn:hover:not(:disabled) {
      background-color: #e9ecef;
      border-color: #adb5bd;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }
    
    .btn--primary {
      background: #007bff;
      color: white;
      border-color: #007bff;
    }
    
    .btn--primary:hover:not(:disabled) {
      background: #0056b3;
      border-color: #0056b3;
      box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    }
    
    .btn--danger {
      background: #dc3545;
      color: white;
      border-color: #dc3545;
    }
    
    .btn--danger:hover:not(:disabled) {
      background: #c82333;
      border-color: #c82333;
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }
    
    .btn--success {
      background: #28a745;
      color: white;
      border-color: #28a745;
    }
    
    .btn--success:hover:not(:disabled) {
      background: #218838;
      border-color: #218838;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
    }
    
    .sectionTitle {
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
      font-weight: 600;
      font-size: 1.1rem;
      color: #495057;
      border-bottom: 2px solid #e9ecef;
      padding-bottom: 0.5rem;
    }
    
    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®çµ±ä¸€ã‚¯ãƒ©ã‚¹ */
    .form-group {
      margin-bottom: 1rem;
    }
    
    /* éŸ³å£°ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®åŒºåˆ‡ã‚Š */
    .audio-generation-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 2rem;
      border-radius: 12px;
      margin-bottom: 1.25rem;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    
    .audio-generation-section:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-1px);
    }
    
    .text-input-section {
      background: #ffffff;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1.25rem;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    
    .text-input-section:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-1px);
    }
    
    .generation-controls-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 1.25rem;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    
    .generation-controls-section:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-1px);
    }
    
    .audio-result-section {
      background: #ffffff;
      padding: 1rem;
      border-radius: 12px;
      margin-bottom: 0.75rem;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    
    .audio-result-section:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-1px);
    }
    
    .audio-result-section .sectionTitle {
      margin-top: 0;
      margin-bottom: 1rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.4rem;
      font-weight: 500;
      color: #495057;
      font-size: 0.9rem;
    }
    
    .form-control {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      transition: all 0.3s ease;
      background: #fff;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
      transform: translateY(-1px);
    }
    
    .form-control:hover {
      border-color: #007bff;
    }
    
    .form-control--textarea {
      resize: vertical;
      line-height: 1.5;
    }
    
    .form-control--select {
      cursor: pointer;
    }


    /* ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã®æœ€é©åŒ– */
    #fileButtons {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      align-items: center;
      z-index: 1002;
    }
    
    #fileToggle {
      background: #6c757d;
      color: white;
      border: none;
      padding: 0.6rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    
    #fileToggle:hover {
      background: #5a6268;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    #fileActions {
      display: flex;
      gap: 0.5rem;
      margin-right: 0.5rem;
      opacity: 0;
      transform: translateX(20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      pointer-events: none;
    }
    
    #fileActions.expanded {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }
    
    #fileActions button {
      border: none;
      padding: 0.6rem 0.8rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    #saveBtn {
      background: #28a745;
      color: white;
    }
    
    #loadBtn {
      background: #007bff;
      color: white;
    }
    
    #saveBtn:hover {
      background: #218838;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }
    
    #loadBtn:hover {
      background: #0056b3;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
    }

    /* å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æœ€é©åŒ– */
    .right-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 630px;
      min-width: 630px;
      max-width: 100vw;
      height: 100vh;
      background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
      box-shadow: -3px 0 25px rgba(0,0,0,0.15);
      z-index: 1050;
      padding: 0;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-left: 1px solid #e0e0e0;
      backdrop-filter: blur(10px);
    }
    
    .right-sidebar.closed {
      transform: translateX(100%);
    }
    
    .tab-header {
      display: flex;
      border-bottom: 2px solid #e9ecef;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .tab-btn {
      flex: 1;
      min-width: 0;
      padding: 1.25rem 0.75rem;
      border: none;
      background: transparent;
      font-size: 0.9rem;
      cursor: pointer;
      outline: none;
      border-right: 1px solid #dee2e6;
      transition: all 0.3s ease;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6c757d;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .tab-btn:last-child {
      border-right: none;
    }
    
    .tab-btn:hover {
      background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
      color: #495057;
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .tab-btn.active {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      font-weight: 700;
      color: #007bff;
      border-bottom: 3px solid #007bff;
      box-shadow: 0 -2px 8px rgba(0, 123, 255, 0.2);
    }
    .tab-content {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      background: #ffffff;
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* è¨­å®šãƒœã‚¿ãƒ³ã®æœ€é©åŒ– */
    #settingsBtn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      z-index: 1100;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(0, 123, 255, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    #settingsBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(0, 123, 255, 0.4);
      background: #0056b3;
    }
    
    /* ã‚°ãƒ­ãƒ¼ãƒãƒ«Redoãƒœã‚¿ãƒ³ã®æœ€é©åŒ– */
    #globalRedoBtn {
      position: fixed;
      bottom: 6rem;
      right: 2rem;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #dc3545;
      color: white;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      z-index: 1100;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(220, 53, 69, 0.3);
      display: none;
      align-items: center;
      justify-content: center;
    }
    
    #globalRedoBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 30px rgba(220, 53, 69, 0.4);
      background: #c82333;
    }
    
    #globalRedoBtn.visible {
      display: flex;
    }

    /* è¨­å®šãƒœã‚¿ãƒ³ã®ãƒ›ãƒãƒ¼åŠ¹æœ */
    #settingsBtn:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      border-color: #aaa;
    }
    
    #settingsBtn:active, #settingsBtn:focus {
      outline: none;
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã®ã‚¿ã‚¤ãƒˆãƒ«èª¿æ•´ */
    #sidebar h2 {
      font-size: 1.2rem;
      margin: 0 0 1.25rem 0;
      color: #2c3e50;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    
    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã®ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºèª¿æ•´ */
    #sidebar button {
      padding: 0.875rem 1.25rem;
      font-size: 0.9rem;
      margin-bottom: 0.875rem;
      border-radius: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.3s ease;
    }
    
    #sidebar button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    /* çµ±åˆéŸ³å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒœã‚¿ãƒ³èª¿æ•´ */
    #downloadBtn {
      padding: 0.875rem 1.25rem;
      font-size: 0.9rem;
      margin-top: 1rem;
      border-radius: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* å¤‰æ›´é€šçŸ¥ã®èª¿æ•´ */
    #changeNotice {
      color: #dc3545;
      font-weight: 600;
      margin-top: 0.75rem;
      display: none;
      padding: 0.5rem;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      font-size: 0.9rem;
    }

    /* ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    #debugMenuContainer {
      position:fixed;
      top:0;
      left:50%;
      transform:translateX(-50%);
      z-index:2000;
      background:#222;
      color:#fff;
      padding:0.75rem 1rem 1rem 1rem;
      border-radius:0 0 8px 8px;
      box-shadow:0 4px 16px rgba(0,0,0,0.2);
      display:none;
      min-width:320px;
      max-width:90vw;
    }
    
    #debugMenuContainer label {
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
    }
    
    #debugMenuContainer input {
      margin-right:0.75rem;
    }
    
    #debugMenuContent {
      margin-top:1rem;
      max-height:350px;
      overflow:auto;
      font-size:0.9rem;
      background:#333;
      padding:1rem;
      border-radius:6px;
      display:none;
    }

    /* ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .debug-table {
      border-collapse:collapse;
      width:100%;
      margin-top:0.5rem;
      font-size:0.9rem;
    }
    
    .debug-table th, .debug-table td {
      border:1px solid #444;
      padding:0.5rem;
      text-align:left;
    }
    
    .debug-table th {
      background:#333;
      color:#fff;
    }
    
    .debug-table tr:nth-child(even) {
      background:#222;
    }
    
    .debug-table tr:hover {
      background:#555;
    }
    
    /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
    ::-webkit-scrollbar {
      width: 8px;
      background-color: #f1f1f1;
    }
    
    ::-webkit-scrollbar-thumb {
      border-radius: 10px;
      background-color: #007bff;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background-color: #0056b3;
    }
    
    ::-webkit-scrollbar-track {
      border-radius: 10px;
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>

  <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="debugMenuContainer" style="position:fixed;top:0;left:50%;transform:translateX(-50%);z-index:2000;background:#222;color:#fff;padding:0.75rem 1rem 1rem 1rem;border-radius:0 0 8px 8px;box-shadow:0 4px 16px rgba(0,0,0,0.2);display:none;min-width:320px;max-width:90vw;">
    <label style="font-weight:600;cursor:pointer;display:flex;align-items:center;">
      <input type="checkbox" id="debugMenuToggle" style="margin-right:0.75rem;">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
    </label>
    <div style="margin-top:0.75rem;display:flex;gap:0.5rem;flex-wrap:wrap;">
      <button id="debugTabTextMidChange" style="padding:0.5rem 0.75rem;font-size:0.8rem;">TextMidChange</button>
      <button id="debugTabPool" style="padding:0.5rem 0.75rem;font-size:0.8rem;">Pool</button>
      <button id="debugTabChanged" style="padding:0.5rem 0.75rem;font-size:0.8rem;">Changed</button>
      <button id="debugTabDPool" style="padding:0.5rem 0.75rem;font-size:0.8rem;">DPool</button>
    </div>
    <div id="debugMenuContent" style="margin-top:1rem;max-height:350px;overflow:auto;font-size:0.9rem;background:#333;padding:1rem;border-radius:6px;display:none;"></div>
  </div>
  <script>
    // ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ‡æ›¿
    const debugMenuContainer = document.getElementById('debugMenuContainer');
    const debugMenuToggle = document.getElementById('debugMenuToggle');
    const debugMenuContent = document.getElementById('debugMenuContent');
    let debugMenuVisible = false; // åˆæœŸã¯éè¡¨ç¤º
    
    // Ctrl+Shift+Dã§ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        debugMenuVisible = !debugMenuVisible;
        debugMenuContainer.style.display = debugMenuVisible ? 'block' : 'none';
        if (debugMenuVisible && debugMenuToggle.checked) {
          updateDebugMenu();
        }
      }
    });
    
    debugMenuToggle.addEventListener('change', () => {
      debugMenuContent.style.display = debugMenuToggle.checked ? 'block' : 'none';
      if (debugMenuToggle.checked) updateDebugMenu();
    });

    // Poolã®å†…å®¹ã‚’ä¸€æ™‚çš„ã«ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    window._debugPool = null;

    // ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã‚¿ãƒ–åˆ¥ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–¢æ•°
    function renderTextMidChangeTab(now) {
      let html = `<b>TextMidChangeï¼ˆè¡Œ:ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ, åˆ—:å±¥æ­´ï¼‰</b> <span style='font-size:0.9em;color:#8ff;'>(æ›´æ–°: ${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3,'0')})</span><br>`;
      html += '<table border="1" style="border-collapse:collapse;font-size:0.95em;background:#222;color:#fff;width:100%;min-width:700px;table-layout:fixed;">';
      html += '<thead><tr><th style="width:40px;">è¡Œ</th>';
      for (let j = 0; j < 10; j++) html += `<th style="width:120px;">${j+1}</th>`;
      html += '</tr></thead><tbody>';
      for (let i = 0; i < TextMidChange.length; i++) {
        html += `<tr><td style="font-weight:bold;">${i}</td>`;
        for (let j = 0; j < 10; j++) {
          html += `<td style="max-width:180px;overflow-wrap:anywhere;min-width:80px;">${TextMidChange[i] && typeof TextMidChange[i][j] !== 'undefined' ? TextMidChange[i][j] : ''}</td>`;
        }
        html += '</tr>';
      }
      html += '</tbody></table>';
      return html;
    }

    function renderPoolTab(now) {
      let html = `<b>Poolï¼ˆç›´è¿‘ã®è¡Œãƒ»åˆ—æ“ä½œæ™‚ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰</b> <span style='font-size:0.9em;color:#8ff;'>(æ›´æ–°: ${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3,'0')})</span><br>`;
      if (window._debugPool) {
        html += '<table border="1" style="border-collapse:collapse;font-size:0.95em;background:#222;color:#fff;width:100%;min-width:700px;table-layout:fixed;">';
        html += '<thead><tr><th style="width:40px;">è¡Œ</th>';
        for (let j = 0; j < 10; j++) html += `<th style="width:120px;">${j+1}</th>`;
        html += '</tr></thead><tbody>';
        for (let i = 0; i < window._debugPool.length; i++) {
          html += `<tr><td style="font-weight:bold;">${i}</td>`;
          for (let j = 0; j < 10; j++) {
            html += `<td style="max-width:180px;overflow-wrap:anywhere;min-width:80px;">${window._debugPool[i] && typeof window._debugPool[i][j] !== 'undefined' ? window._debugPool[i][j] : ''}</td>`;
          }
          html += '</tr>';
        }
        html += '</tbody></table>';
      } else {
        html += '<span style="color:#faa;">Poolã¯ã¾ã è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</span>';
      }
      return html;
    }

    function renderChangedTab(now) {
      let html = `<b>Changedï¼ˆçµ±åˆMP3å†ç”Ÿæˆæ™‚ã®æœ€æ–°çŠ¶æ…‹ï¼‰</b> <span style='font-size:0.9em;color:#8ff;'>(æ›´æ–°: ${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3,'0')})</span><br>`;
      html += `<span style='color:#ccc;'>è¡Œæ•°: ${window.Changed.length}</span><br>`;
      if (window.Changed.length > 0) {
        html += '<table border="1" style="border-collapse:collapse;font-size:0.95em;background:#222;color:#fff;width:100%;min-width:500px;">';
        html += '<thead><tr><th style="width:40px;">è¡Œ</th><th style="width:300px;">ãƒ†ã‚­ã‚¹ãƒˆ</th><th style="width:80px;">å£°</th><th style="width:100px;">éµ</th></tr></thead><tbody>';
        for (let i = 0; i < window.Changed.length; i++) {
          const item = window.Changed[i];
          html += `<tr><td style="font-weight:bold;">${i}</td>`;
          html += `<td style="max-width:300px;overflow-wrap:anywhere;">${item.text || ''}</td>`;
          html += `<td>${item.vid || ''}</td>`;
          html += `<td style="font-size:0.8em;">${item.ttsboxId || ''}</td>`;
          html += '</tr>';
        }
        html += '</tbody></table>';
      } else {
        html += '<span style="color:#faa;">Changedã¯ç©ºã§ã™ã€‚</span>';
      }
      return html;
    }

    function renderDPoolTab(now) {
      const dPoolData = segmentManager.deletedSegments;
      let html = `<b>DPoolï¼ˆå‰Šé™¤ã•ã‚ŒãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆå±¥æ­´ï¼‰</b> <span style='font-size:0.9em;color:#8ff;'>(æ›´æ–°: ${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3,'0')})</span><br>`;
      html += `<span style='color:#ccc;'>ä»¶æ•°: ${dPoolData.length}/20</span><br>`;
      if (dPoolData.length > 0) {
        html += '<div style="margin-bottom:0.5em;"><button onclick="revertAllFromDPool()" style="background:#d9534f;color:white;border:none;padding:0.3em 0.8em;border-radius:4px;cursor:pointer;">å…¨å·®ã—æˆ»ã—</button></div>';
        html += '<table border="1" style="border-collapse:collapse;font-size:0.95em;background:#222;color:#fff;width:100%;min-width:600px;">';
        html += '<thead><tr><th style="width:40px;">No.</th><th style="width:60px;">å…ƒä½ç½®</th><th style="width:250px;">ãƒ†ã‚­ã‚¹ãƒˆ</th><th style="width:80px;">å£°</th><th style="width:80px;">æ¬¡ã®éµ</th><th style="width:80px;">æ“ä½œ</th></tr></thead><tbody>';
        for (let i = 0; i < dPoolData.length; i++) {
          const item = dPoolData[i];
          html += `<tr><td style="font-weight:bold;">${i+1}</td>`;
          html += `<td>${item.index}</td>`;
          html += `<td style="max-width:250px;overflow-wrap:anywhere;">${item.segment.text || ''}</td>`;
          html += `<td>${item.segment.vid || ''}</td>`;
          html += `<td>${item.nextKey || 'ãªã—'}</td>`;
          html += `<td><button onclick="revertSingleFromDPool(${i})" style="background:#007bff;color:white;border:none;padding:0.2em 0.5em;border-radius:3px;cursor:pointer;font-size:0.8em;">å¾©å…ƒ</button></td>`;
          html += '</tr>';
        }
        html += '</tbody></table>';
      } else {
        html += '<span style="color:#faa;">DPoolã¯ç©ºã§ã™ã€‚</span>';
      }
      return html;
    }

    function updateDebugMenu() {
      if (!window.TextMidChange) return;
      const now = new Date();
      const activeTab = window._debugTab || 'TextMidChange';
      
      let html = '';
      switch (activeTab) {
        case 'TextMidChange':
          html = renderTextMidChangeTab(now);
          break;
        case 'Pool':
          html = renderPoolTab(now);
          break;
        case 'Changed':
          html = renderChangedTab(now);
          break;
        case 'DPool':
          html = renderDPoolTab(now);
          break;
      }
      
      debugMenuContent.innerHTML = html;
    }
    // TextMidChangeæ›´æ–°æ™‚ã«ãƒ‡ãƒãƒƒã‚°å†…å®¹ã‚‚æ›´æ–°
    window.updateDebugMenu = updateDebugMenu;

    // ãƒ‡ãƒãƒƒã‚°ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    window._debugTab = 'TextMidChange';
    document.addEventListener('DOMContentLoaded', () => {
      const tab1 = document.getElementById('debugTabTextMidChange');
      const tab2 = document.getElementById('debugTabPool');
      const tab3 = document.getElementById('debugTabChanged');
      const tab4 = document.getElementById('debugTabDPool');
      if (tab1 && tab2 && tab3 && tab4) {
        tab1.onclick = () => { window._debugTab = 'TextMidChange'; updateDebugMenu(); };
        tab2.onclick = () => { window._debugTab = 'Pool'; updateDebugMenu(); };
        tab3.onclick = () => { window._debugTab = 'Changed'; updateDebugMenu(); };
        tab4.onclick = () => { window._debugTab = 'DPool'; updateDebugMenu(); };
      }
      
      // DPoolãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
      updateGlobalRedoButton();
    });

    // è‡ªå‹•æ›´æ–°ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹æ™‚ï¼‰
    setInterval(() => {
      if (debugMenuToggle.checked) updateDebugMenu();
    }, 1000);
    
    // DPoolå·®ã—æˆ»ã—æ©Ÿèƒ½
    window.revertSingleFromDPool = function(index) {
      if (index >= 0 && index < segmentManager.getDeletedCount()) {
        // æœ€å¾Œã®ã‚¢ã‚¤ãƒ†ãƒ ã®ã¿å¾©å…ƒå¯¾å¿œ
        if (index === segmentManager.getDeletedCount() - 1) {
          const result = segmentManager.restoreDeletedSegment();
          if (result) {
            currentSegments = segmentManager.getAllSegments();
            regenerateBtn.disabled = false;
            updateChangeNotice();
            renderSegmentsUI(currentSegments);
            updateVoiceFilterOptions();
            updateGlobalRedoButton();
            if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
          }
        }
      }
    };
    
    window.revertAllFromDPool = function() {
      const deletedCount = segmentManager.getDeletedCount();
      if (deletedCount === 0) return;
      
      const confirmRevert = confirm(`DPoolã®å…¨${deletedCount}é …ç›®ã‚’å·®ã—æˆ»ã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
      if (!confirmRevert) return;
      
      // å¾Œå‰Šé™¤ã‹ã‚‰å…ˆã«å¾©å…ƒ
      while (segmentManager.getDeletedCount() > 0) {
        segmentManager.restoreDeletedSegment();
      }
      
      currentSegments = segmentManager.getAllSegments();
      regenerateBtn.disabled = false;
      updateChangeNotice();
      renderSegmentsUI(currentSegments);
      updateVoiceFilterOptions();
      updateGlobalRedoButton();
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
    };
  </script>
  <div id="sidebarToggle">â‰¡ å…¥åŠ›</div>

  <div id="sidebar" class="">
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ -->
    <div id="fileButtons" style="margin-bottom: 1.5rem;">
      <div id="fileActions">
        <button id="saveBtn">ğŸ’¾</button>
        <button id="loadBtn">ğŸ“‚</button>
      </div>
      <button id="fileToggle">ğŸ“</button>
    </div>
    
    <!-- éŸ³å£°è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="audio-generation-section" style="margin-top: 1rem;">
      <h2>éŸ³å£°ç”Ÿæˆ</h2>
      <div class="form-group">
        <label for="voiceSelect" class="form-label">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å£°:</label>
        <select id="voiceSelect" class="form-control form-control--select">
          <option value="2">æ‹“ä¹Ÿã•ã‚“ / CV.SHOW</option>
          <option value="3">MISAKI</option>
          <option value="4">SAYAKA</option>
          <option value="5">HIKARI</option>
          <option value="6">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ / CV.HARUKA</option>
          <option value="7">RYO</option>
          <option value="8">ãƒ¬ã‚ª / CV.TAKERU</option>
        </select>
      </div>
    </div>
    
    <!-- ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="text-input-section">
      <div class="form-group">
        <label for="textInput" class="form-label">ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›:</label>
        <textarea id="textInput" class="form-control form-control--textarea" rows="8">ã€Œã‚¯ãƒªã‚¹ãƒã‚¹ãƒ»ã‚¤ãƒ–ã¯ï¼“æ—¥é–“ãã‚‰ã„ã‚ã‚‹ã¨ã„ã„ã‚“ã ã‚ˆã­ã€‚ã ã£ã¦ã•ãã€ã‚¤ãƒ´ã®æ—¥ã¨ã‹ã«ä¸€äººã®ã‚ªãƒ³ãƒŠã®å­ã¨ã‹ã„ã£ã±ã„ã„ã¦ã‹ã‚ã„ãã†ã˜ã‚ƒã‚“ï¼ã€ãªã‚“ã¦è¨€ã£ã¦ã„ãªãŒã‚‰ã€ã‚ªãƒ¬ã«ã¨ã£ã¦ã®æœ¬å‘½ãã‚“ãŒã¯ãŸã—ã¦ã‚¤ãƒ–ã«å‘¼ã‚“ã§ãã‚Œã‚‹ã‹ã©ã†ã‹ã‚„ã£ã±ã‚Šæ°—ã«ãªã‚‹ã€‚æœ¬å‘½ã‚¯ãƒ³ã¯æ±ºã—ã¦çµ¶å¯¾ã«ç´„æŸãªã‚“ã‹ã—ã¦ãã‚Œãªã„ã€‚ã ã‹ã‚‰ã‚ªãƒ¬ã¯ã‚°ãƒ¬ã¾ãã£ã¦ã‚¦ãƒªãªã‚“ã‹ã‚„ã£ã¦ã„ã‚‹ã€‚ãã‚Œã«çµ¶å¯¾æ±ºã—ã¦ã€Œå¥½ãã ã€ãªã‚“ã¦è¨€ã£ã¦ãã‚Œãªã„ã€‚å˜ãªã‚‹ã€Œãƒšãƒƒãƒˆã€ã¨ã—ã¦æ„›ã—ã¦ãã‚Œã¦ã„ã‚‹ã ã‘ã ã€‚</textarea>
        <div id="charCount" class="text-small text-muted mt-1">0æ–‡å­—</div>
      </div>
    </div>

    <!-- ç”Ÿæˆãƒœã‚¿ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="generation-controls-section">
      <div class="form-group">
        <button id="generateBtn" class="btn btn--primary">MP3ã‚’ç”Ÿæˆ</button>
        <button id="regenerateBtn" class="btn btn--danger" disabled>ç·¨é›†å¾Œã®MP3ã‚’å†ç”Ÿæˆ</button>
      </div>
    </div>

    <!-- çµ±åˆéŸ³å£°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="audio-result-section">
      <div class="sectionTitle">çµ±åˆéŸ³å£°</div>
      <div id="result"></div>
      <button id="downloadBtn" disabled>MP3ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <div id="changeNotice">å¤‰æ›´ç‚¹ãŒæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
    </div>
  </div>

  <div id="main">
    <br>
    <div class="sectionTitle">å˜æ–‡åˆ¥éŸ³å£°</div>
    <div id="segmentsAudioList"></div>
  </div>

  <!-- å³ä¸‹è¨­å®šãƒœã‚¿ãƒ³ -->
  <button id="settingsBtn">âš™</button>

  <!-- çµ±åˆRedoãƒœã‚¿ãƒ³ -->
  <button id="globalRedoBtn">â†º</button>

  <!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <div id="rightSidebar" class="right-sidebar">
    <div class="tab-header">
      <button class="tab-btn active" data-tab="tab-desc">èª¬æ˜æ›¸</button>
      <button class="tab-btn" data-tab="tab-filter">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</button>
      <button class="tab-btn" data-tab="tab-batch">ãƒãƒƒãƒæ“ä½œ</button>
      <button class="tab-btn" data-tab="tab-segment">ç²¾æ–‡åŒ–</button>
      <button class="tab-btn" data-tab="tab-download">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>
    <div class="tab-content" id="tab-desc" style="display:block;">
      <h3>Kusaikoid ver.beta5.0 ä½¿ç”¨æ–¹æ³•</h3>
      <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’éŸ³å£°ã«å¤‰æ›ã—ã€ç·¨é›†ãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒã§ãã‚‹Webã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚</p>
      <h4>åŸºæœ¬çš„ãªä½¿ã„æ–¹</h4>
      <ol>
        <li>å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å£°ã‚’é¸æŠ</li>
        <li>ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›</li>
        <li>ã€ŒMP3ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
        <li>ç”Ÿæˆã•ã‚ŒãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å€‹åˆ¥ã«ç·¨é›†å¯èƒ½</li>
        <li>ç·¨é›†å¾Œã¯ã€Œç·¨é›†å¾Œã®MP3ã‚’å†ç”Ÿæˆã€ã§çµ±åˆéŸ³å£°ã‚’æ›´æ–°</li>
        <li>ã€ŒMP3ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜</li>
      </ol>
      <h4>æ©Ÿèƒ½ç´¹ä»‹</h4>
      <ul>
        <li><strong>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç·¨é›†:</strong> å„æ–‡ç« ã‚’å€‹åˆ¥ã«ç·¨é›†ãƒ»å†ç”Ÿæˆ</li>
        <li><strong>å£°ã®å¤‰æ›´:</strong> ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚‹å£°ã‚’è¨­å®š</li>
        <li><strong>å±¥æ­´æ©Ÿèƒ½:</strong> ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ç·¨é›†å±¥æ­´ã‚’ç®¡ç†</li>
        <li><strong>ãƒãƒƒãƒæ“ä½œ:</strong> è¤‡æ•°ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¸€æ‹¬æ“ä½œ</li>
        <li><strong>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½:</strong> ç‰¹å®šã®æ¡ä»¶ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’çµã‚Šè¾¼ã¿</li>
      </ul>
    </div>
    <div class="tab-content" id="tab-filter" style="display:none;">
      <h3>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</h3>
      <div class="form-group">
        <label class="form-label">å£°ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
        <select id="voiceFilter" class="form-control">
          <option value="">ã™ã¹ã¦ã®å£°</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ç·¨é›†çŠ¶æ…‹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼:</label>
        <select id="editedFilter" class="form-control">
          <option value="">ã™ã¹ã¦</option>
          <option value="edited">ç·¨é›†æ¸ˆã¿ã®ã¿</option>
          <option value="original">æœªç·¨é›†ã®ã¿</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢:</label>
        <input type="text" id="textFilter" class="form-control" placeholder="æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰">
      </div>
      <button id="applyFilter" class="btn btn--primary">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’é©ç”¨</button>
      <button id="clearFilter" class="btn">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‚¯ãƒªã‚¢</button>
    </div>
    <div class="tab-content" id="tab-batch" style="display:none;">
      <h3>ãƒãƒƒãƒæ“ä½œ</h3>
      <div class="form-group">
        <label class="form-label">å¯¾è±¡ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ:</label>
        <select id="batchTarget" class="form-control">
          <option value="all">ã™ã¹ã¦</option>
          <option value="filtered">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¸ˆã¿</option>
          <option value="selected">é¸æŠæ¸ˆã¿</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">æ“ä½œ:</label>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button id="batchChangeVoice" class="btn">å£°ã‚’ä¸€æ‹¬å¤‰æ›´</button>
          <button id="batchRegenerate" class="btn">ä¸€æ‹¬å†ç”Ÿæˆ</button>
          <button id="batchDelete" class="btn btn--danger">ä¸€æ‹¬å‰Šé™¤</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">ä¸€æ‹¬å¤‰æ›´ç”¨ã®å£°:</label>
        <select id="batchVoiceSelect" class="form-control">
          <option value="2">æ‹“ä¹Ÿã•ã‚“ / CV.SHOW</option>
          <option value="3">MISAKI</option>
          <option value="4">SAYAKA</option>
          <option value="5">HIKARI</option>
          <option value="6">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ / CV.HARUKA</option>
          <option value="7">RYO</option>
          <option value="8">ãƒ¬ã‚ª / CV.TAKERU</option>
        </select>
      </div>
    </div>
    <div class="tab-content" id="tab-segment" style="display:none;">
      <h3>ç²¾æ–‡åŒ–</h3>
      <p>ãƒ†ã‚­ã‚¹ãƒˆã®åˆ†å‰²ã‚„çµåˆã‚’è¡Œã„ã¾ã™ã€‚</p>
      <div class="form-group">
        <label class="form-label">åˆ†å‰²è¨­å®š:</label>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button id="splitBySentence" class="btn">å¥ç‚¹ã§åˆ†å‰²</button>
          <button id="splitByLength" class="btn">æ–‡å­—æ•°ã§åˆ†å‰²</button>
          <button id="mergeSegments" class="btn">ã‚»ã‚°ãƒ¡ãƒ³ãƒˆçµåˆ</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">åˆ†å‰²æ–‡å­—æ•°:</label>
        <input type="number" id="splitLength" class="form-control" value="50" min="10" max="200">
      </div>
      <div class="form-group">
        <label class="form-label">ã‚«ã‚¹ã‚¿ãƒ åˆ†å‰²:</label>
        <textarea id="customSplit" class="form-control" rows="3" placeholder="ã“ã“ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦æ‰‹å‹•åˆ†å‰²"></textarea>
        <button id="applyCustomSplit" class="btn btn--primary">ã‚«ã‚¹ã‚¿ãƒ åˆ†å‰²ã‚’é©ç”¨</button>
      </div>
    </div>
    <div class="tab-content" id="tab-download" style="display:none;">
      <h3>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h3>
      <div class="form-group">
        <label class="form-label">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å½¢å¼:</label>
        <select id="downloadFormat" class="form-control">
          <option value="mp3">MP3 (çµ±åˆéŸ³å£°)</option>
          <option value="zip">ZIP (å€‹åˆ¥ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ)</option>
          <option value="json">JSON (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿)</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">ãƒ•ã‚¡ã‚¤ãƒ«å:</label>
        <input type="text" id="downloadFilename" class="form-control" value="kusaikoid_audio">
      </div>
      <button id="downloadCustom" class="btn btn--primary">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
      <hr>
      <div class="form-group">
        <label class="form-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†:</label>
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
          <button id="saveProject" class="btn btn--success">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜</button>
          <button id="loadProject" class="btn">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿</button>
          <button id="newProject" class="btn">æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== DOMè¦ç´ å–å¾— ======
    const generateBtn = document.getElementById('generateBtn');
    const regenerateBtn = document.getElementById('regenerateBtn');
    const textInput = document.getElementById('textInput');
    const charCount = document.getElementById('charCount');
    const resultDiv = document.getElementById('result');
    const downloadBtn = document.getElementById('downloadBtn');
    const segmentsAudioList = document.getElementById('segmentsAudioList');
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('sidebarToggle');
    const defaultVoiceSelect = document.getElementById("voiceSelect");
    const changeNotice = document.getElementById('changeNotice');
    const settingsBtn = document.getElementById('settingsBtn');
    const globalRedoBtn = document.getElementById('globalRedoBtn');
    const rightSidebar = document.getElementById('rightSidebar');

    // ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ
    const fileToggle = document.getElementById('fileToggle');
    const fileActions = document.getElementById('fileActions');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');

    // ====== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ======
    let finalBlobURL = null;
    let currentSegments = [];
    
    // å±¥æ­´ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 
    window.TextMidChange = []; // [è¡Œ][å±¥æ­´] - å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´å±¥æ­´ï¼ˆæœ€å¤§10ä»¶ï¼‰
    window.Changed = []; // çµ±åˆMP3ç”Ÿæˆæ™‚ã®å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæœ€æ–°çŠ¶æ…‹
    
    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    const generateRandomKey = (length = 8) => {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      return Array.from({length}, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
    };
    
    // æ™‚åˆ»éµç”Ÿæˆï¼ˆç¾åœ¨æ™‚åˆ» Ã— 114.514 - ä¸€æ„æ€§ç¢ºä¿ç”¨ï¼‰
    const generateTimeKey = () => {
      const now = Date.now();
      const seconds = Math.floor(now / 1000);
      return Math.floor(seconds * 114.514).toString();
    };
    
    // è¤‡åˆéµç”Ÿæˆï¼ˆæ–‡å­—éµï¼‹æ™‚åˆ»éµï¼‰
    const generateHybridKey = () => {
      const randomPart = generateRandomKey(6);
      const timePart = generateTimeKey();
      return `${randomPart}-${timePart}`;
    };

    // DPoolçŠ¶æ…‹æ›´æ–°
    const updateGlobalRedoButton = () => {
      if (globalRedoBtn) {
        const deletedCount = segmentManager.getDeletedCount();
        if (deletedCount === 0) {
          globalRedoBtn.style.opacity = '0.3';
          globalRedoBtn.style.cursor = 'not-allowed';
        } else {
          globalRedoBtn.style.opacity = '1';
          globalRedoBtn.style.cursor = 'pointer';
        }
      }
    };

    // ====== ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç®¡ç†ã‚¯ãƒ©ã‚¹ ======
    
    class SegmentManager {
      constructor() {
        this.segments = [];
        this.deletedSegments = []; // å‰Šé™¤å±¥æ­´
        this.maxDeletedHistory = 20; // DPoolæœ€å¤§ä¿æŒæ•°
        this.maxTextHistory = 10; // TextMidChangeå±¥æ­´æœ€å¤§æ•°
      }
      
      // è¿½åŠ 
      addSegment(text, vid, ttsboxId = null) {
        const segment = {
          text: text || '',
          vid: vid || '2',
          ttsboxId: ttsboxId || generateHybridKey()
        };
        this.segments.push(segment);
        return segment;
      }
      
      // å‰Šé™¤ï¼ˆDPoolã«ä¿å­˜ï¼‰
      deleteSegment(index) {
        if (index >= 0 && index < this.segments.length) {
          const segment = this.segments[index];
          const nextKey = index + 1 < this.segments.length ? this.segments[index + 1].ttsboxId : null;
          
          const deletedItem = {
            segment: { ...segment },
            index: index,
            history: window.TextMidChange[index] ? [...window.TextMidChange[index]] : [segment.text],
            nextKey: nextKey
          };
          
          this.deletedSegments.push(deletedItem);
          if (this.deletedSegments.length > this.maxDeletedHistory) {
            this.deletedSegments.shift();
          }
          
          this.segments.splice(index, 1);
          window.deleteTMCrow(index);
          return deletedItem;
        }
        return null;
      }
      
      // æŒ¿å…¥
      insertSegment(index, text = 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚', vid = '2') {
        const segment = this.addSegment(text, vid);
        this.segments.splice(index, 0, this.segments.pop());
        window.insertTMCrow(index, text);
        return segment;
      }
      
      // å¾©å…ƒ
      restoreDeletedSegment() {
        if (this.deletedSegments.length === 0) return null;
        
        const item = this.deletedSegments.pop();
        let insertIndex = 0;
        
        if (item.nextKey) {
          // nextKeyï¼ˆå‰Šé™¤æ™‚ã®æ¬¡è¦ç´ IDï¼‰ã‚’æ¢ã—ã¦é©åˆ‡ãªä½ç½®ã«å¾©å…ƒ
          const targetIndex = this.segments.findIndex(seg => seg.ttsboxId === item.nextKey);
          if (targetIndex !== -1) {
            insertIndex = targetIndex; // æ¬¡è¦ç´ ã®å‰ã«æŒ¿å…¥
          } else {
            insertIndex = Math.min(item.index, this.segments.length); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          }
        } else {
          insertIndex = this.segments.length; // æœ€å¾Œã«å‰Šé™¤ã•ã‚ŒãŸå ´åˆã¯æœ«å°¾ã«è¿½åŠ 
        }
        
        this.segments.splice(insertIndex, 0, item.segment);
        window.insertTMCrow(insertIndex, item.segment.text);
        if (item.history && item.history.length > 0) {
          window.TextMidChange[insertIndex] = [...item.history];
        }
        
        return { segment: item.segment, index: insertIndex };
      }
      
      // å…¨å–å¾—
      getAllSegments() {
        return [...this.segments];
      }
      
      // æ›´æ–°
      updateSegment(index, updates) {
        if (index >= 0 && index < this.segments.length) {
          Object.assign(this.segments[index], updates);
          return this.segments[index];
        }
        return null;
      }
      
      // ä»¶æ•°
      getCount() {
        return this.segments.length;
      }
      
      // å‰Šé™¤ä»¶æ•°
      getDeletedCount() {
        return this.deletedSegments.length;
      }
      
      // ã‚¯ãƒªã‚¢
      clear() {
        this.segments = [];
        this.deletedSegments = [];
        window.TextMidChange = [];
        window.Changed = [];
      }
      
      // ãƒ­ãƒ¼ãƒ‰
      loadData(segmentsData, textMidChange = [], changed = [], deletedSegments = []) {
        this.segments = segmentsData.map(seg => ({
          text: seg.text || '',
          vid: seg.vid || '2',
          ttsboxId: seg.ttsboxId || generateHybridKey()
        }));
        this.deletedSegments = deletedSegments.slice(0, this.maxDeletedHistory);
        window.TextMidChange = textMidChange;
        window.Changed = changed;
      }
    }
    
    class SegmentElement {
      constructor(segment, index, segmentManager, audioBlob = null) {
        this.segment = segment;
        this.index = index;
        this.segmentManager = segmentManager;
        this.audioBlob = audioBlob;
        this.historyIndex = 0;
        this.elements = {};
        
        this.createElement();
        this.setupEventHandlers();
      }
      
      createElement() {
        // ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
        this.elements.container = createSegmentContainer(this.segment, this.index);
        this.elements.textarea = createSegmentTextarea(this.segment, this.index);
        this.elements.playButton = createPlayButton(this.audioBlob);
        this.elements.voiceSelect = createVoiceSelect(this.segment);
        
        const { restoreButton, redoButton } = createHistoryButtons();
        this.elements.restoreButton = restoreButton;
        this.elements.redoButton = redoButton;
        
        const { deleteButton, insertAboveButton, insertBelowButton } = createActionButtons(this.segment);
        this.elements.deleteButton = deleteButton;
        this.elements.insertAboveButton = insertAboveButton;
        this.elements.insertBelowButton = insertBelowButton;
        
        // ã‚°ãƒ«ãƒ¼ãƒ—ä½œæˆ
        const playGroup = document.createElement('div');
        playGroup.className = 'control-group control-group--play';
        playGroup.appendChild(this.elements.playButton);
        
        const voiceGroup = document.createElement('div');
        voiceGroup.className = 'control-group control-group--voice';
        voiceGroup.appendChild(this.elements.voiceSelect);
        
        const historyGroup = document.createElement('div');
        historyGroup.className = 'control-group control-group--history';
        historyGroup.append(this.elements.restoreButton, this.elements.redoButton);
        
        const actionGroup = document.createElement('div');
        actionGroup.className = 'control-group control-group--actions';
        actionGroup.append(this.elements.deleteButton, this.elements.insertAboveButton, this.elements.insertBelowButton);
        
        const controls = document.createElement('div');
        controls.className = 'segment-controls';
        controls.append(playGroup, historyGroup, voiceGroup, actionGroup);
        
        this.elements.container.append(this.elements.textarea, controls);
        
        // TextMidChangeã®åˆæœŸåŒ–
        this.initializeTextHistory();
      }
      
      initializeTextHistory() {
        if (!window.TextMidChange[this.index]) {
          window.TextMidChange[this.index] = [];
        }
        const newText = this.segment.text;
        if (window.TextMidChange[this.index][0] !== newText) {
          window.TextMidChange[this.index].unshift(newText);
          if (window.TextMidChange[this.index].length > 10) {
            window.TextMidChange[this.index].length = 10;
          }
        }
      }
      
      setupEventHandlers() {
        // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
        this.elements.textarea.oninput = () => {
          this.segment.text = this.elements.textarea.value.trim();
          regenerateBtn.disabled = false;
          updateChangeNotice();
        };
        
        this.elements.textarea.onblur = async () => {
          if (!regenerateBtn.disabled) {
            await this.handleTextChange();
          }
        };
        
        // éŸ³å£°å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
        this.elements.voiceSelect.onchange = async () => {
          await this.handleVoiceChange();
        };
        
        // å±¥æ­´ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        this.elements.restoreButton.onclick = async () => {
          await this.handleHistoryRestore();
        };
        
        this.elements.redoButton.onclick = async () => {
          await this.handleHistoryRedo();
        };
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
        this.elements.deleteButton.onclick = async () => {
          await this.handleDelete();
        };
        
        this.elements.insertAboveButton.onclick = async () => {
          await this.handleInsert('above');
        };
        
        this.elements.insertBelowButton.onclick = async () => {
          await this.handleInsert('below');
        };
        
        // åˆæœŸçŠ¶æ…‹è¨­å®š
        this.updateHistoryButtonStates();
      }
      
      async handleTextChange() {
        this.segment.text = this.elements.textarea.value.trim();
        
        // å±¥æ­´æ›´æ–°
        if (!window.TextMidChange[this.index]) window.TextMidChange[this.index] = [];
        
        if (this.historyIndex === 0) {
          if (window.TextMidChange[this.index][0] !== this.segment.text) {
            window.TextMidChange[this.index].unshift(this.segment.text);
          } else {
            window.TextMidChange[this.index][0] = this.segment.text;
          }
        } else {
          window.TextMidChange[this.index][0] = this.segment.text;
        }
        
        // é‡è¤‡é™¤å»
        for (let k = 1; k < window.TextMidChange[this.index].length; k++) {
          if (window.TextMidChange[this.index][k] === this.segment.text) {
            window.TextMidChange[this.index].splice(k, 1);
            k--;
          }
        }
        if (window.TextMidChange[this.index].length > 10) {
          window.TextMidChange[this.index].length = 10;
        }
        
        this.historyIndex = 0;
        
        try {
          await this.regenerateAudio();
          diagnoseAndUpdateEditedState(this.elements.container, this.index);
          updateVoiceFilterOptions();
          applyVoiceFilter();
        } catch (error) {
          console.error('éŸ³å£°å†ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        }
        
        this.updateHistoryButtonStates();
        if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) {
          window.updateDebugMenu();
        }
      }
      
      async handleVoiceChange() {
        this.segment.vid = this.elements.voiceSelect.value;
        this.elements.container.dataset.voice = this.segment.vid;
        regenerateBtn.disabled = false;
        updateChangeNotice();
        updateVoiceFilterOptions();
        applyVoiceFilter();
        
        try {
          await this.regenerateAudio();
          diagnoseAndUpdateEditedState(this.elements.container, this.index);
        } catch (error) {
          console.error('éŸ³å£°å†ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        }
      }
      
      async handleHistoryRestore() {
        if (this.elements.restoreButton.disabled) return;
        
        const nextIndex = this.historyIndex + 1;
        const previousText = window.TextMidChange[this.index][nextIndex];
        this.elements.textarea.value = previousText;
        this.segment.text = previousText;
        this.historyIndex = nextIndex;
        
        regenerateBtn.disabled = false;
        updateChangeNotice();
        this.updateHistoryButtonStates();
        
        try {
          await this.regenerateAudio();
        } catch (error) {
          console.error('éŸ³å£°å†ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        }
      }
      
      async handleHistoryRedo() {
        if (this.elements.redoButton.disabled) return;
        
        const nextIndex = this.historyIndex - 1;
        const nextText = window.TextMidChange[this.index][nextIndex];
        this.elements.textarea.value = nextText;
        this.segment.text = nextText;
        this.historyIndex = nextIndex;
        
        regenerateBtn.disabled = false;
        updateChangeNotice();
        this.updateHistoryButtonStates();
        
        try {
          await this.regenerateAudio();
        } catch (error) {
          console.error('éŸ³å£°å†ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
        }
      }
      
      async handleDelete() {
        const deletedItem = this.segmentManager.deleteSegment(this.index);
        if (deletedItem) {
          regenerateBtn.disabled = false;
          updateChangeNotice();
          renderSegmentsUI(this.segmentManager.getAllSegments());
          updateVoiceFilterOptions();
          updateGlobalRedoButton();
        }
      }
      
      async handleInsert(position) {
        const insertIndex = position === 'above' ? this.index : this.index + 1;
        this.segmentManager.insertSegment(insertIndex, 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚', this.segment.vid);
        regenerateBtn.disabled = false;
        updateChangeNotice();
        renderSegmentsUI(this.segmentManager.getAllSegments());
        updateVoiceFilterOptions();
      }
      
      async regenerateAudio() {
        this.elements.playButton.disabled = true;
        this.elements.playButton.textContent = 'ç”Ÿæˆä¸­...';
        
        try {
          const newBlob = await fetchMP3Blob(generateTTSURL(this.segment.vid, this.segment.text));
          this.audioBlob = newBlob;
          this.elements.playButton.textContent = 'ğŸ”Š å†ç”Ÿ';
          this.elements.playButton.disabled = false;
          this.elements.playButton.onclick = () => {
            if (this.audioBlob) new Audio(URL.createObjectURL(this.audioBlob)).play();
          };
        } catch (error) {
          this.elements.playButton.textContent = 'ã‚¨ãƒ©ãƒ¼';
          this.elements.playButton.disabled = true;
          throw error;
        }
      }
      
      updateHistoryButtonStates() {
        updateRestoreButtonState(this.elements.restoreButton, this.index, this.historyIndex, this.elements.textarea);
        updateRedoButtonState(this.elements.redoButton, this.index, this.historyIndex, this.elements.textarea);
      }
      
      getElement() {
        return this.elements.container;
      }
      
      destroy() {
        if (this.elements.container.parentNode) {
          this.elements.container.parentNode.removeChild(this.elements.container);
        }
      }
    }
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
    const segmentManager = new SegmentManager();

    // ====== ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¦ç´ ä½œæˆ ======
    
    // ãƒ¡ã‚¤ãƒ³ã‚»ã‚°ãƒ¡ãƒ³ãƒˆä½œæˆé–¢æ•°ï¼ˆã‚¯ãƒ©ã‚¹ãƒ™ãƒ¼ã‚¹ï¼‰
    const createSegmentElement = (seg, index, segmentsData, segmentBlobs) => {
      const segmentElement = new SegmentElement(seg, index, segmentManager, segmentBlobs[index]);
      return segmentElement.getElement();
    };

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰
    toggle.addEventListener('click', () => {
      sidebar.classList.toggle('closed');
      const main = document.getElementById('main');
      main.style.marginLeft = sidebar.classList.contains('closed') ? '0' : '355px';
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
    fileToggle.addEventListener('click', () => {
      fileActions.classList.toggle('expanded');
    });

    // ä¿å­˜æ©Ÿèƒ½ï¼ˆJSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¿å­˜ï¼ˆJSONå½¢å¼ï¼‰
    saveBtn.addEventListener('click', () => {
      const saveData = {
        version: "1.0",
        timestamp: new Date().toISOString(),
        inputText: textInput.value,
        defaultVoice: defaultVoiceSelect.value,
        currentSegments: segmentManager.getAllSegments(),
        textMidChange: window.TextMidChange, // å±¥æ­´ãƒ‡ãƒ¼ã‚¿
        changed: window.Changed,
        dPool: segmentManager.deletedSegments // å‰Šé™¤å±¥æ­´
      };
      
      const jsonString = JSON.stringify(saveData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const fileName = `kusaikoid_project_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      a.click();
      
      URL.revokeObjectURL(url);
      fileActions.classList.remove('expanded');
      
      console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', fileName);
    });

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆèª­ã¿è¾¼ã¿ï¼ˆJSON/TXTå¯¾å¿œï¼‰
    loadBtn.addEventListener('click', () => {
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json,.txt';
      fileInput.style.display = 'none';
      
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const text = await file.text();
          
          if (file.name.toLowerCase().endsWith('.json')) {
            // JSONå¾©å…ƒå‡¦ç†
            const saveData = JSON.parse(text);
            
            if (!saveData.version) {
              throw new Error('ç„¡åŠ¹ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
            }
            
            // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ
            if (saveData.inputText !== undefined) {
              textInput.value = saveData.inputText;
              charCount.textContent = `${textInput.value.length}æ–‡å­—`;
            }
            
            if (saveData.defaultVoice !== undefined) {
              defaultVoiceSelect.value = saveData.defaultVoice;
            }
            
            if (saveData.currentSegments) {
              segmentManager.loadData(
                saveData.currentSegments,
                saveData.textMidChange || [],
                saveData.changed || [],
                saveData.dPool || []
              );
              currentSegments = segmentManager.getAllSegments();
            }
            
            console.log('JSONãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', file.name);
            console.log('èª­ã¿è¾¼ã¿æ—¥æ™‚:', saveData.timestamp);
            
          } else if (file.name.toLowerCase().endsWith('.txt')) {
            // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ï¼ˆVID:ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼‰
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const segments = [];
            
            for (const line of lines) {
              // ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
              if (line.startsWith('#')) continue;
              
              // VID:ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®è§£æ
              const match = line.match(/^(\d+):(.+)$/);
              if (match) {
                const vid = match[1];
                const segmentText = match[2].trim();
                
                // VIDãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ2-8ã®ç¯„å›²ï¼‰
                if (vid >= '2' && vid <= '8') {
                  segments.push({
                    text: segmentText,
                    vid: vid,
                    ttsboxId: generateHybridKey()
                  });
                } else {
                  console.warn(`ç„¡åŠ¹ãªVID: ${vid} (è¡Œ: ${line})`);
                }
              } else {
                console.warn(`ç„¡åŠ¹ãªå½¢å¼ã®è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—: ${line}`);
              }
            }
            
            if (segments.length === 0) {
              throw new Error('æœ‰åŠ¹ãªã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚VID:ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚');
            }
            
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
            segmentManager.loadData(segments, [], [], []);
            currentSegments = segmentManager.getAllSegments();
            
            // å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            textInput.value = '';
            charCount.textContent = '0æ–‡å­—';
            
            console.log(`ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ${file.name} (${segments.length}ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ)`);
            
          } else {
            throw new Error('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚JSONã¾ãŸã¯TXTãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          }
          
          // UIã‚’å†æç”»
          if (currentSegments.length > 0) {
            renderSegmentsUI(currentSegments);
            updateVoiceFilterOptions();
            
            // èª­ã¿è¾¼ã¿å¾Œã«è‡ªå‹•çš„ã«MP3ã‚’å†ç”Ÿæˆ
            console.log('èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€MP3ã‚’è‡ªå‹•å†ç”Ÿæˆã—ã¾ã™...');
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰MP3å†ç”Ÿæˆã‚’å®Ÿè¡Œï¼ˆUIã®æç”»ãŒå®Œäº†ã™ã‚‹ã¾ã§ï¼‰
            setTimeout(async () => {
              try {
                await generateAudioFromSegments(currentSegments);
                regenerateBtn.disabled = true;
                updateChangeNotice();
                console.log('MP3ã®è‡ªå‹•å†ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
              } catch (error) {
                console.error('MP3è‡ªå‹•å†ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('MP3ã®è‡ªå‹•å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
              }
            }, 100);
          }
          
          // DPoolãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
          updateGlobalRedoButton();
          
          // ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°
          if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) {
            window.updateDebugMenu();
          }
          
          // ãƒ•ã‚¡ã‚¤ãƒ«ãƒœã‚¿ãƒ³ã‚’é–‰ã˜ã‚‹
          fileActions.classList.remove('expanded');
          
        } catch (error) {
          console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
        
        // inputè¦ç´ ã‚’å‰Šé™¤
        document.body.removeChild(fileInput);
      });
      
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      document.body.appendChild(fileInput);
      fileInput.click();
    });

    // ä»–ã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒœã‚¿ãƒ³ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', (e) => {
      if (!fileToggle.contains(e.target) && !fileActions.contains(e.target)) {
        fileActions.classList.remove('expanded');
      }
    });

    // ====== æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ ======
    textInput.addEventListener('input', () => {
      charCount.textContent = `${textInput.value.length}æ–‡å­—`;
    });
    charCount.textContent = `${textInput.value.length}æ–‡å­—`;

    // ====== å¤‰æ›´é€šçŸ¥åˆ¶å¾¡ ======
    function updateChangeNotice() {
      if (!regenerateBtn.disabled) {
        changeNotice.style.display = 'block';
      } else {
        changeNotice.style.display = 'none';
      }
    }



    // TTS URLç”Ÿæˆ
    function generateTTSURL(vid, text) {
      // URL/API ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ç‰¹æ®Šæ–‡å­—ã‚’æ—¥æœ¬èªã«ç½®æ›
      const sanitized = text.replace(/&/g, 'ã‚¢ãƒ³ãƒ‰').replace(/=/g, 'ã‚¤ã‚³ãƒ¼ãƒ«');
      return `https://cache-a.oddcast.com/tts/genC.php?EID=3&LID=12&VID=${vid}&TXT=${encodeURIComponent(sanitized)}&EXT=mp3&FNAME=&ACC=15679&SceneID=2646118&HTTP_ERR=`;
    }

    // ãƒ†ã‚­ã‚¹ãƒˆåˆ†å‰²ï¼ˆã€‚ï¼ï¼Ÿã§åŒºåˆ‡ã‚Šï¼‰
    function splitTextBySentence(text) {
      // æ­£è¦è¡¨ç¾ã§æ–‡æœ«ï¼ˆã€‚ï¼ï¼Ÿï¼‰ã”ã¨ã«åˆ†å‰²
      const sentences = text.match(/[^ã€‚ï¼ï¼Ÿ\r\n]*[ã€‚ï¼ï¼Ÿ]?/g) || [];
      return sentences.map(s => s.trim()).filter(Boolean);
    }


    // MP3 Blobå–å¾—
    async function fetchMP3Blob(url) {
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã«å¤±æ•—");
      return await res.blob();
    }

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–
    function initializeSegmentData(segmentsData) {
      // Changedãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆåˆå›è¡¨ç¤ºæ™‚ã‚„æ–°è¦ç”Ÿæˆæ™‚ï¼‰
      if (window.Changed.length === 0) {
        window.Changed = [];
        for (let i = 0; i < segmentsData.length; i++) {
          window.Changed.push({
            text: segmentsData[i].text,
            vid: segmentsData[i].vid,
            ttsboxId: segmentsData[i].ttsboxId || generateHybridKey()
          });
        }
      }
      
      // TextMidChangeã®è¡Œæ•°ã‚’segmentsDataã«åˆã‚ã›ã¦èª¿æ•´
      while (TextMidChange.length < segmentsData.length) TextMidChange.push([]);
      while (TextMidChange.length > segmentsData.length) TextMidChange.pop();
      
      // æ—¢å­˜è¡Œã¯ä¸Šæ›¸ãã—ãªã„ã€‚ç©ºè¡Œã®ã¿åˆæœŸåŒ–ã€‚
      for (let i = 0; i < segmentsData.length; i++) {
        if (!TextMidChange[i] || TextMidChange[i].length === 0) {
          TextMidChange[i] = [segmentsData[i].text, '', '', '', '', '', '', '', '', ''];
        }
      }
    }

    function createTextArea(seg, i, segmentsData, ttsbox, currentHistoryIndexRef) {
      const textarea = document.createElement('textarea');
      textarea.rows = 2;
      textarea.value = seg.text;
      textarea.dataset.index = i;
      
      // å…¥åŠ›ä¸­ã¯å¤‰æ›´ãƒ•ãƒ©ã‚°ã®ã¿ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ã«å†ç”Ÿæˆ
      textarea.oninput = () => {
        seg.text = textarea.value.trim();
        regenerateBtn.disabled = false;
        updateChangeNotice();
      };
      
      textarea.onblur = async () => {
        // ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿å†ç”Ÿæˆ
        if (!regenerateBtn.disabled) {
          // TextMidChangeã‚‚ã“ã“ã§æ›´æ–°ï¼ˆ0åˆ—ç›®ã¯å¸¸ã«æœ€æ–°ãƒ†ã‚­ã‚¹ãƒˆï¼‰
          seg.text = textarea.value.trim();
          if (!TextMidChange[i]) TextMidChange[i] = [];
          
          if (currentHistoryIndexRef.value === 0) {
            // æœ€æ–°å±¥æ­´ã‹ã‚‰ç·¨é›†ã—ãŸå ´åˆã¯é€šå¸¸ã®å‡¦ç†
            if (TextMidChange[i][0] !== seg.text) {
              TextMidChange[i].unshift(seg.text);
            } else {
              TextMidChange[i][0] = seg.text;
            }
          } else {
            // éæœ€æ–°å±¥æ­´ã‹ã‚‰ç·¨é›†ã—ãŸå ´åˆã¯0ç•ªç›®ã‚’ä¸Šæ›¸ã
            TextMidChange[i][0] = seg.text;
          }
          
          // 0åˆ—ç›®ä»¥å¤–ã®é‡è¤‡ã‚’é™¤å»
          for (let k = 1; k < TextMidChange[i].length; k++) {
            if (TextMidChange[i][k] === seg.text) {
              TextMidChange[i].splice(k, 1);
              k--;
            }
          }
          if (TextMidChange[i].length > 10) TextMidChange[i].length = 10;
          
          // ç¾åœ¨ã®å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
          currentHistoryIndexRef.value = 0;
          
          if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
          
          // ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¦data-editedã‚’æ›´æ–°
          diagnoseAndUpdateEditedState(ttsbox, i);
        }
      };
      
      return textarea;
    }

    function createVoiceSelect(seg, i, ttsbox) {
      const voiceSelect = defaultVoiceSelect.cloneNode(true);
      voiceSelect.removeAttribute('id');
      voiceSelect.title = 'éŸ³å£°ã®ç¨®é¡ã‚’é¸æŠ';
      voiceSelect.value = seg.vid;
      
      voiceSelect.onchange = async () => {
        console.log(`Voice changed from ${seg.vid} to ${voiceSelect.value} for segment index ${i}`);
        seg.vid = voiceSelect.value;
        // ttsboxã®data-voiceã‚‚æ›´æ–°
        ttsbox.dataset.voice = voiceSelect.value;
        regenerateBtn.disabled = false;
        updateChangeNotice();
        
        console.log('About to call updateVoiceFilterOptions() after voice change');
        // éŸ³å£°å¤‰æ›´æ™‚ã«å³åº§ã«ãƒ•ã‚£ãƒ«ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
        updateVoiceFilterOptions();
        applyVoiceFilter();
        console.log('updateVoiceFilterOptions() and applyVoiceFilter() completed');
        
        // ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¦data-editedã‚’æ›´æ–°
        diagnoseAndUpdateEditedState(ttsbox, i);
        
        if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
      };
      
      return voiceSelect;
    }

    function createHistoryButtons(i, textarea, seg, ttsbox, currentHistoryIndexRef) {
      // æˆ»ã™ãƒœã‚¿ãƒ³ï¼ˆTextMidChangeã‹ã‚‰å±¥æ­´ã‚’å‘¼ã³æˆ»ã™ï¼‰
      const restoreButton = document.createElement('button');
      restoreButton.textContent = 'â†º';
      restoreButton.title = 'ãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´ã‹ã‚‰æˆ»ã™';
      
      // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
      const updateRestoreButtonState = () => {
        const canUndo = TextMidChange[i] && TextMidChange[i].length > 1 && 
                       currentHistoryIndexRef.value + 1 < TextMidChange[i].length && 
                       currentHistoryIndexRef.value + 1 < 10 && 
                       TextMidChange[i][currentHistoryIndexRef.value + 1] && 
                       TextMidChange[i][currentHistoryIndexRef.value + 1] !== '' &&
                       TextMidChange[i][currentHistoryIndexRef.value + 1] !== textarea.value;
        
        if (canUndo) {
          restoreButton.style.opacity = '1';
          restoreButton.disabled = false;
        } else {
          restoreButton.style.opacity = '0.3';
          restoreButton.disabled = true;
        }
      };
      
      restoreButton.onclick = () => {
        if (restoreButton.disabled) return;
        
        const nextIndex = currentHistoryIndexRef.value + 1;
        const previousText = TextMidChange[i][nextIndex];
        textarea.value = previousText;
        seg.text = previousText;
        currentHistoryIndexRef.value = nextIndex;
        
        regenerateBtn.disabled = false;
        updateChangeNotice();
        updateRestoreButtonState();
        updateRedoButtonState();
        
        // ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¦data-editedã‚’æ›´æ–°
        diagnoseAndUpdateEditedState(ttsbox, i);
      };

      // ã‚„ã‚Šç›´ã—ãƒœã‚¿ãƒ³ï¼ˆTextMidChangeã‹ã‚‰é€²ã‚“ã å±¥æ­´ã‚’å‘¼ã³æˆ»ã™ï¼‰
      const redoButton = document.createElement('button');
      redoButton.textContent = 'â†»';
      redoButton.title = 'ãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´ã‚’ã‚„ã‚Šç›´ã™';
      
      const updateRedoButtonState = () => {
        const canRedo = TextMidChange[i] && currentHistoryIndexRef.value > 0 && 
                       TextMidChange[i][currentHistoryIndexRef.value - 1] && 
                       TextMidChange[i][currentHistoryIndexRef.value - 1] !== '' &&
                       TextMidChange[i][currentHistoryIndexRef.value - 1] !== textarea.value;
        
        if (canRedo) {
          redoButton.style.opacity = '1';
          redoButton.disabled = false;
        } else {
          redoButton.style.opacity = '0.3';
          redoButton.disabled = true;
        }
      };
      
      redoButton.onclick = () => {
        if (redoButton.disabled) return;
        
        const nextIndex = currentHistoryIndexRef.value - 1;
        const nextText = TextMidChange[i][nextIndex];
        textarea.value = nextText;
        seg.text = nextText;
        currentHistoryIndexRef.value = nextIndex;
        
        regenerateBtn.disabled = false;
        updateChangeNotice();
        updateRestoreButtonState();
        updateRedoButtonState();
        
        // ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¦data-editedã‚’æ›´æ–°
        diagnoseAndUpdateEditedState(ttsbox, i);
      };
      
      // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
      updateRestoreButtonState();
      updateRedoButtonState();
      
      return { restoreButton, redoButton, updateRestoreButtonState, updateRedoButtonState };
    }

    function createSegmentActionButtons(i, seg, segmentsData, ttsbox) {
      // ã‚´ãƒŸç®±ãƒœã‚¿ãƒ³
      const deleteButton = document.createElement('button');
      deleteButton.textContent = 'ğŸ—‘ï¸';
      deleteButton.title = 'ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤';
      deleteButton.onclick = () => {
        // å‰Šé™¤ã•ã‚Œã‚‹è¦ç´ ã®æ¬¡ã®è¦ç´ ã«éµã‚’ä¸ãˆã‚‹
        const nextSibling = ttsbox.nextElementSibling;
        let nextKey = null;
        if (nextSibling && nextSibling.dataset.ttsboxId) {
          nextKey = nextSibling.dataset.ttsboxId;
        }
        
        // DPoolã«å‰Šé™¤ã•ã‚Œã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜
        const deletedSegment = {
          segment: { ...segmentsData[i] },
          index: i,
          history: window.TextMidChange[i] ? [...window.TextMidChange[i]] : [segmentsData[i].text],
          nextKey: nextKey // å¾©å…ƒæ™‚ã®ç›®å°ã¨ãªã‚‹éµ
        };
        DPool.push(deletedSegment);
        
        // DPoolã®æœ€å¤§ã‚µã‚¤ã‚ºã‚’20ã«åˆ¶é™
        if (DPool.length > 20) {
          DPool.shift();
        }
        
        segmentsData.splice(i, 1);
        window.deleteTMCrow(i);
        regenerateBtn.disabled = false;
        updateChangeNotice();
        renderSegmentsUI(segmentsData);
        updateVoiceFilterOptions();
        updateGlobalRedoButton(); // DPoolãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
      };

      // ä¸Šä¸‹è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
      const insertAboveButton = document.createElement('button');
      insertAboveButton.textContent = 'ï¼‹ä¸Š';
      insertAboveButton.title = 'ã“ã®ä¸Šã«æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
      insertAboveButton.onclick = () => {
        const newSegments = segmentsData.slice(0, i)
          .concat([{ text: 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚', vid: seg.vid, ttsboxId: generateHybridKey() }])
          .concat(segmentsData.slice(i));
        window.insertTMCrow(i, 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚');
        regenerateBtn.disabled = false;
        updateChangeNotice();
        renderSegmentsUI(newSegments);
        updateVoiceFilterOptions();
        if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
        currentSegments = newSegments;
      };
      
      const insertBelowButton = document.createElement('button');
      insertBelowButton.textContent = 'ï¼‹ä¸‹';
      insertBelowButton.title = 'ã“ã®ä¸‹ã«æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
      insertBelowButton.onclick = () => {
        const newSegments = segmentsData.slice(0, i + 1)
          .concat([{ text: 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚', vid: seg.vid, ttsboxId: generateHybridKey() }])
          .concat(segmentsData.slice(i + 1));
        window.insertTMCrow(i + 1, 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚');
        regenerateBtn.disabled = false;
        updateChangeNotice();
        renderSegmentsUI(newSegments);
        updateVoiceFilterOptions();
        if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
        currentSegments = newSegments;
      };
      
      return { deleteButton, insertAboveButton, insertBelowButton };
    }

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆUIæç”»
    function renderSegmentsUI(segmentsData) {
  segmentsAudioList.innerHTML = '';
  
  initializeSegmentData(segmentsData);
  
  if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
  
  segmentsData.forEach((seg, i) => {
    // ttsboxãƒ©ãƒƒãƒ‘ãƒ¼div
    const ttsbox = document.createElement('div');
    ttsbox.className = 'ttsbox';
    ttsbox.dataset.voice = seg.vid || '';
    ttsbox.dataset.selected = seg.selected === true ? 'true' : 'false';
    ttsbox.dataset.visible = seg.visible === false ? 'false' : 'true';
    ttsbox.dataset.column = i; // åˆ—ç•ªå·ã‚’data-columnå±æ€§ã§ä»˜ä¸
    
    // å„ttsboxã«ä¸€æ„IDã‚’ä»˜ä¸ï¼ˆéµã‚·ã‚¹ãƒ†ãƒ ï¼‰
    if (!seg.ttsboxId) {
      seg.ttsboxId = generateHybridKey();
    }
    ttsbox.dataset.ttsboxId = seg.ttsboxId;

    // å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    const currentHistoryIndexRef = { value: 0 };

    // å„è¦ç´ ã‚’ä½œæˆ
    const textarea = createTextArea(seg, i, segmentsData, ttsbox, currentHistoryIndexRef);
    const voiceSelect = createVoiceSelect(seg, i, ttsbox);
    const { restoreButton, redoButton } = createHistoryButtons(i, textarea, seg, ttsbox, currentHistoryIndexRef);
    const { deleteButton, insertAboveButton, insertBelowButton } = createSegmentActionButtons(i, seg, segmentsData, ttsbox);

    // å†ç”Ÿãƒœã‚¿ãƒ³ï¼ˆUIã®ã¿ã€ç„¡åŠ¹åŒ–ï¼‰
    const playButton = document.createElement('button');
    playButton.textContent = 'ğŸ”Š å†ç”Ÿ';
    playButton.title = 'ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®éŸ³å£°ã‚’å†ç”Ÿ';
    playButton.disabled = true;

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹
    const controls = document.createElement('div');
    controls.className = 'segment-controls';
    controls.append(playButton, restoreButton, redoButton, voiceSelect, deleteButton, insertAboveButton, insertBelowButton);

    // ttsboxã«è¦ç´ ã‚’ã¾ã¨ã‚ã¦è¿½åŠ 
    ttsbox.append(textarea, controls);
    segmentsAudioList.appendChild(ttsbox);
  });
  
  // åˆæœŸè¡¨ç¤ºæ™‚ã«å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­
  const allTtsboxes = segmentsAudioList.querySelectorAll('.ttsbox');
  allTtsboxes.forEach((ttsbox, index) => {
    diagnoseAndUpdateEditedState(ttsbox, index);
  });
  
  updateVoiceFilterOptions();
}

    // éŸ³å£°ç”Ÿæˆã¨UIåæ˜ 
    async function generateAudioFromSegments(segmentsData) {
      // éŸ³å£°å–å¾—
      async function fetchSegmentAudios(segmentsData) {
      const segmentBlobs = [];
      let ttsCount = 0;
      // APIåˆ¶é™å›é¿: 5ï½10å›ã”ã¨ã«7ï½10ç§’ä¼‘æ­¢
      let ttsLimit = Math.floor(Math.random() * 6) + 5; // 5ï½10
      
      for (let i = 0; i < segmentsData.length; i++) {
        const seg = segmentsData[i];
        const url = generateTTSURL(seg.vid, seg.text);
        try {
          const blob = await fetchMP3Blob(url);
          segmentBlobs.push(blob);
        } catch {
          segmentBlobs.push(null);
        }
        ttsCount++;
        if (ttsCount >= ttsLimit && i < segmentsData.length - 1) {
          // 7ï½10ç§’ä¼‘æ­¢
          const sleepMs = (Math.floor(Math.random() * 4) + 7) * 1000; // 7ï½10ç§’
          await new Promise(res => setTimeout(res, sleepMs));
          ttsCount = 0;
          ttsLimit = Math.floor(Math.random() * 6) + 5; // 5ï½10
        }
      }
      
      return segmentBlobs;
    }

    function setupSegmentUI(segmentsData, segmentBlobs) {
      segmentsAudioList.innerHTML = '';
      
      initializeSegmentData(segmentsData);
      
      // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆè¦ç´ ã‚’ä½œæˆã—ã¦è¿½åŠ ï¼ˆã‚¯ãƒ©ã‚¹ãƒ™ãƒ¼ã‚¹è¨­è¨ˆï¼‰
      segmentManager.loadData(segmentsData, window.TextMidChange, window.Changed, []);
      
      segmentsData.forEach((seg, index) => {
        const segmentElement = createSegmentElement(seg, index, segmentsData, segmentBlobs);
        segmentsAudioList.appendChild(segmentElement);
      });
      
      // åˆæœŸè¡¨ç¤ºæ™‚ã«å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­
      const initialSegmentContainers = segmentsAudioList.querySelectorAll('.segment-container');
      initialSegmentContainers.forEach((container, index) => {
        diagnoseAndUpdateEditedState(container, index);
      });
      
      updateVoiceFilterOptions();
    }

    // UIåˆæœŸåŒ–ãƒ»éŸ³å£°å–å¾—ãƒ»çµ±åˆ
    const segmentBlobs = await fetchSegmentAudios(segmentsData);
    setupSegmentUI(segmentsData, segmentBlobs);
    
    // çµ±åˆéŸ³å£°ç”Ÿæˆ
    const mergedBlob = new Blob(segmentBlobs.filter(blob => blob), { type: 'audio/mpeg' });
    finalBlobURL = URL.createObjectURL(mergedBlob);
    
    const audio = document.createElement('audio');
    audio.controls = true;
    audio.src = finalBlobURL;
    resultDiv.innerHTML = '';
    resultDiv.appendChild(audio);
    
    downloadBtn.disabled = false;
    regenerateBtn.disabled = true;
    updateChangeNotice();
  }

  // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç·¨é›†çŠ¶æ…‹è¨ºæ–­
    function diagnoseAndUpdateEditedState(ttsbox, segmentIndex) {
        const textarea = ttsbox.querySelector('textarea');
        if (!textarea || !window.Changed || segmentIndex >= window.Changed.length) {
            return;
        }
        
        const currentText = textarea.value.trim();
        const changedText = window.Changed[segmentIndex]?.text || '';
        const isEdited = currentText !== changedText;
        
        ttsbox.dataset.edited = isEdited ? 'true' : 'false';
    }

    // ====== MP3ç”Ÿæˆãƒœã‚¿ãƒ³ ======
    generateBtn.addEventListener('click', async () => {
      const rawText = textInput.value.trim();
      const defaultVid = defaultVoiceSelect.value;
      if (!rawText) {
        alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      
      // å±¥æ­´ãƒªã‚»ãƒƒãƒˆã®è­¦å‘Š
      if (window.TextMidChange.length > 0 || window.Changed.length > 0) {
        const confirmReset = confirm("æ–°ã—ã„MP3ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€æ—¢å­˜ã®ç·¨é›†å±¥æ­´ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ");
        if (!confirmReset) {
          return;
        }
      }
      
      // å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
      segmentManager.clear();
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–‡ã”ã¨ã«åˆ†å‰²ã—ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé…åˆ—ã‚’ä½œæˆï¼ˆè¤‡åˆéµã‚‚ä»˜ä¸ï¼‰
      const segments = splitTextBySentence(rawText).map(txt => ({ 
        text: txt, 
        vid: defaultVid,
        ttsboxId: generateHybridKey()
      }));
      
      // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ãƒ­ãƒ¼ãƒ‰
      segmentManager.loadData(segments, [], [], []);
      currentSegments = segmentManager.getAllSegments();
      
      // ã¾ãšUIã®ã¿å³æ™‚æç”»ã›ãšã€åˆå›ã‹ã‚‰éŸ³å£°ç”Ÿæˆã¾ã§è¡Œã†
      await generateAudioFromSegments(currentSegments);
      regenerateBtn.disabled = true;
      updateChangeNotice();
    });

    // ====== å†ç”Ÿæˆãƒœã‚¿ãƒ³ ======
    regenerateBtn.addEventListener('click', async () => {
      // currentSegmentsã‚‚åŒæœŸæ›´æ–°
      const allSegmentContainers = document.querySelectorAll('.segment-container');
      allSegmentContainers.forEach((container, index) => {
        const textarea = container.querySelector('textarea');
        const voiceSelect = container.querySelector('select');
        if (textarea && voiceSelect && currentSegments[index]) {
          currentSegments[index].text = textarea.value.trim();
          currentSegments[index].vid = voiceSelect.value;
        }
      });
      
      await generateAudioFromSegments(currentSegments);
      regenerateBtn.disabled = true;
      updateChangeNotice();
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
    });

    // ====== ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ ======
    downloadBtn.addEventListener('click', () => {
      if (!finalBlobURL) return;
      const a = document.createElement('a');
      a.href = finalBlobURL;
      a.download = 'merged_audio.mp3';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // åˆæœŸè¡¨ç¤ºæ™‚ã¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆUIã‚’æç”»ã—ãªã„ï¼ˆmp3ç”Ÿæˆæ™‚ã®ã¿ç”Ÿæˆï¼‰

    // å³ä¸‹âš™ãƒœã‚¿ãƒ³ã§å³ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰
    settingsBtn.addEventListener('click', () => {
      rightSidebar.classList.toggle('closed');
    });

    // çµ±åˆRedoãƒœã‚¿ãƒ³ã®å‡¦ç†ï¼ˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ä½¿ç”¨ï¼‰
    globalRedoBtn.addEventListener('click', () => {
      // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‹ã‚‰ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å¾©å…ƒ
      const result = segmentManager.restoreDeletedSegment();
      if (result) {
        currentSegments = segmentManager.getAllSegments();
        regenerateBtn.disabled = false;
        updateChangeNotice();
        renderSegmentsUI(currentSegments);
        updateVoiceFilterOptions();
        updateGlobalRedoButton();
        if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
      }
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabContents.forEach(tc => tc.style.display = 'none');
        const target = document.getElementById(btn.dataset.tab);
        if (target) target.style.display = 'block';
      });
    });


    // ====== èª¬æ˜ã‚¿ãƒ–è¨­å®š ======
    const descTab = document.getElementById('tab-desc');
    descTab.innerHTML = `
      <div style="padding: 1em; font-size: 1.2em; line-height: 1.6;">
        <h3 style="margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 0.5em;font-size: 2.0em;">KUSAIKOID ver.beta5.0</h3>
        
        <h4>åŸºæœ¬çš„ãªä½¿ã„æ–¹</h4>
        <ol>
          <li><strong>ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›</strong>: å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›</li>
          <li><strong>éŸ³å£°ç”Ÿæˆ</strong>: ã€ŒMP3ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å‰²ï¼‹éŸ³å£°ç”Ÿæˆ</li>
          <li><strong>ç·¨é›†</strong>: å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆã‚„éŸ³å£°ã‚’å€‹åˆ¥ã«ç·¨é›†å¯èƒ½</li>
          <li><strong>å†ç”Ÿæˆ</strong>: ç·¨é›†å¾Œã¯ã€Œç·¨é›†å¾Œã®MP3ã‚’å†ç”Ÿæˆã€ã§çµ±åˆéŸ³å£°ã‚’æ›´æ–°</li>
        </ol>
        
        <h4>ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½</h4>
        <p><strong>ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿</strong>: å·¦ä¸Šã®ğŸ“ãƒœã‚¿ãƒ³ã‹ã‚‰å±•é–‹</p>
        <ul>
          <li><strong>ğŸ’¾ ä¿å­˜</strong>: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜</li>
          <li><strong>ğŸ“‚ èª­ã¿è¾¼ã¿</strong>: 
            <ul>
              <li><strong>JSONãƒ•ã‚¡ã‚¤ãƒ«</strong>: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œå…¨å¾©å…ƒ</li>
              <li><strong>TXTãƒ•ã‚¡ã‚¤ãƒ«</strong>: å°æœ¬å½¢å¼ï¼ˆVID:ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‹ã‚‰èª­ã¿è¾¼ã¿</li>
            </ul>
          </li>
        </ul>

        <h4>å°æœ¬å½¢å¼ï¼ˆTXTãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</h4>
        <p>ä»¥ä¸‹ã®å½¢å¼ã§ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨èª­ã¿è¾¼ã¿å¯èƒ½:</p>
        <pre style="background: #f5f5f5; padding: 0.5em; border-radius: 4px; font-size: 0.8em;">2:æ‹“ä¹Ÿã®å°„ç²¾ã€€3000å††
# ã‚³ãƒ¡ãƒ³ãƒˆè¡Œï¼ˆ#ã§å§‹ã¾ã‚‹è¡Œã¯ç„¡è¦–ã•ã‚Œã¾ã™ï¼‰</pre>
        <h4>éŸ³å£°IDï¼ˆVIDï¼‰ä¸€è¦§</h4>
        <ul style="columns: 2; column-gap: 1em;">
          <li><strong>VID:2</strong> - æ‹“ä¹Ÿã•ã‚“ / CV.SHOW</li>
          <li><strong>VID:3</strong> - MISAKI</li>
          <li><strong>VID:4</strong> - SAYAKA</li>
          <li><strong>VID:5</strong> - HIKARI</li>
          <li><strong>VID:6</strong> - ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ / CV.HARUKA</li>
          <li><strong>VID:7</strong> - RYO</li>
          <li><strong>VID:8</strong> - ãƒ¬ã‚ª / CV.TAKERU</li>
        </ul>
        
        <h4>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç·¨é›†</h4>
        <ul>
          <li><strong>ğŸ”Š å†ç”Ÿ</strong>: å€‹åˆ¥ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéŸ³å£°ã®å†ç”Ÿ</li>
          <li><strong>â†º/â†»</strong>: ãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´ã®æˆ»ã‚‹ãƒ»é€²ã‚€ï¼ˆæœ€å¤§10ä»¶ï¼‰</li>
          <li><strong>éŸ³å£°é¸æŠ</strong>: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚‹éŸ³å£°ã‚’é¸æŠå¯èƒ½</li>
          <li><strong>ğŸ—‘ï¸ å‰Šé™¤</strong>: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå‰Šé™¤ï¼ˆå‰Šé™¤ãƒ—ãƒ¼ãƒ«ã«ä¿å­˜ï¼‰</li>
          <li><strong>ï¼‹ä¸Š/ï¼‹ä¸‹</strong>: æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¸Šä¸‹ã«æŒ¿å…¥</li>
        </ul>
        
        <h4>å±¥æ­´ãƒ»å¾©å…ƒæ©Ÿèƒ½</h4>
        <ul>
          <li><strong>ç·¨é›†å±¥æ­´</strong>: å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ã‚’æœ€å¤§10ä»¶è¨˜éŒ²</li>
          <li><strong>å‰Šé™¤ãƒ—ãƒ¼ãƒ«</strong>: å‰Šé™¤ã—ãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æœ€å¤§20ä»¶ä¿å­˜</li>
          <li><strong>â†ºãƒœã‚¿ãƒ³</strong>: å‰Šé™¤ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã®ä¸€æ‹¬å¾©å…ƒ</li>
          <li><strong>çŠ¶æ…‹è¨ºæ–­</strong>: ç·¨é›†çŠ¶æ…‹ã‚’è‡ªå‹•åˆ¤å®šãƒ»è¡¨ç¤º</li>
        </ul>
        
        <h4>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½</h4>
        <ul>
          <li><strong>éŸ³å£°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</strong>: ç‰¹å®šã®éŸ³å£°ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã¿è¡¨ç¤º</li>
          <li><strong>ç·¨é›†çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</strong>: ç·¨é›†æ¸ˆã¿/æœªç·¨é›†ã§çµã‚Šè¾¼ã¿</li>
          <li><strong>ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</strong>: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†…å®¹ã§ã®æ¤œç´¢</li>
        </ul>
        
        <h4>ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</h4>
        <p><strong>Ctrl+Shift+D</strong>: ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆå†…éƒ¨çŠ¶æ…‹ç¢ºèªç”¨ï¼‰</p>
        
        <h4>æ³¨æ„äº‹é …</h4>
        <ul>
          <li>éŸ³å£°ç”Ÿæˆã«ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…è¦ã§ã™</li>
          <li>å¤§é‡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¯ç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</li>
          <li>5-10å›ã®éŸ³å£°ç”Ÿæˆã”ã¨ã«7-10ç§’ã®ä¼‘æ­¢ãŒå…¥ã‚Šã¾ã™</li>
          <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒªãƒ­ãƒ¼ãƒ‰ã§æœªä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™</li>
        </ul>
      </div>
    `;

    // ãƒ•ã‚£ãƒ«ã‚¿ã‚¿ãƒ–ã«ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
    const filterTab = document.getElementById('tab-filter');
    // éŸ³å£°åãƒªã‚¹ãƒˆï¼ˆvoiceSelectã‹ã‚‰å–å¾—ï¼‰
    const voiceSelectOptions = Array.from(defaultVoiceSelect.options).map(opt => ({ value: opt.value, label: opt.textContent }));

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
    const filterLabel = document.createElement('label');
    filterLabel.textContent = 'éŸ³å£°ãƒ•ã‚£ãƒ«ã‚¿:';
    filterLabel.style.marginRight = '0.5em';
    const filterSelect = document.createElement('select');
    filterSelect.style.minWidth = '160px';
    filterLabel.appendChild(filterSelect);
    filterTab.appendChild(filterLabel);

    // ç·¨é›†çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
    const editStateDiv = document.createElement('div');
    editStateDiv.style.marginTop = '1em';
    editStateDiv.style.marginBottom = '0.7em';
    const editStateLabel = document.createElement('label');
    editStateLabel.textContent = 'ç·¨é›†çŠ¶æ…‹:';
    editStateLabel.style.marginRight = '0.5em';
    const editStateSelect = document.createElement('select');
    editStateSelect.style.minWidth = '120px';
    [
      { value: '', label: 'ã™ã¹ã¦' },
      { value: 'false', label: 'æœªç·¨é›†' },
      { value: 'true', label: 'ç·¨é›†æ¸ˆã¿' }
    ].forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.value;
      o.textContent = opt.label;
      editStateSelect.appendChild(o);
    });
    editStateLabel.appendChild(editStateSelect);
    editStateDiv.appendChild(editStateLabel);
    filterTab.appendChild(editStateDiv);

    // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹è¿½åŠ 
    const searchDiv = document.createElement('div');
    searchDiv.style.marginTop = '1em';
    const searchLabel = document.createElement('label');
    searchLabel.textContent = 'ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢:';
    searchLabel.style.marginRight = '0.5em';
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›';
    searchInput.style.minWidth = '160px';
    searchDiv.appendChild(searchLabel);
    searchDiv.appendChild(searchInput);
    filterTab.appendChild(searchDiv);

    // ä½¿ç”¨ä¸­ã®voiceã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ã‚»ãƒ¬ã‚¯ãƒˆã«è¡¨ç¤ºã™ã‚‹
    function updateVoiceFilterOptions() {
      // ç¾åœ¨ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã§ä½¿ã‚ã‚Œã¦ã„ã‚‹voiceã‚’é›†è¨ˆ
      const usedVoices = new Set();
      const segmentContainers = segmentsAudioList.querySelectorAll('.segment-container');
      console.log('updateVoiceFilterOptions: found', segmentContainers.length, 'segment containers');
      segmentContainers.forEach((container, index) => {
        // selectãƒœãƒƒã‚¯ã‚¹ã®å®Ÿéš›ã®å€¤ã‚’å‚ç…§ï¼ˆå‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒæ§˜ï¼‰
        const select = container.querySelector('select');
        const voice = select ? select.value : '';
        console.log(`Segment ${index}: select.value="${voice}"`);
        if (voice) usedVoices.add(voice);
      });
      console.log('Used voices:', Array.from(usedVoices));
      console.log('Available voiceSelectOptions:', voiceSelectOptions);
      console.log('Current filter options before update:', Array.from(filterSelect.options).map(o => ({ value: o.value, text: o.textContent })));
      
      // é¸æŠè‚¢ã‚’å†æ§‹ç¯‰
      const prev = filterSelect.value;
      filterSelect.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = 'ã™ã¹ã¦';
      filterSelect.appendChild(optAll);
      
      let addedCount = 0;
      voiceSelectOptions.forEach(opt => {
        console.log(`Checking option: value="${opt.value}", label="${opt.label}", isUsed=${usedVoices.has(opt.value)}`);
        if (usedVoices.has(opt.value)) {
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.label;
          filterSelect.appendChild(o);
          addedCount++;
          console.log(`Added filter option: ${opt.label} (${opt.value})`);
        }
      });
      console.log(`Total filter options added: ${addedCount}`);
      console.log('Filter options after update:', Array.from(filterSelect.options).map(o => ({ value: o.value, text: o.textContent })));
      
      // ç›´å‰ã®é¸æŠå€¤ãŒæ®‹ã£ã¦ã„ã‚Œã°ç¶­æŒ
      if ([...filterSelect.options].some(o => o.value === prev)) {
        filterSelect.value = prev;
      } else {
        filterSelect.value = '';
      }
    }


    // ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†æœ¬ä½“ï¼ˆéŸ³å£°ãƒ•ã‚£ãƒ«ã‚¿ï¼‹ç·¨é›†çŠ¶æ…‹ï¼‹ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ï¼‰
    function applyVoiceFilter() {
      const voiceVal = filterSelect.value;
      const searchVal = searchInput.value.trim();
      const editStateVal = editStateSelect.value;
      // segment-containerå˜ä½ã§å‡¦ç†
      const segmentContainers = segmentsAudioList.querySelectorAll('.segment-container');
      segmentContainers.forEach(container => {
        // selectãƒœãƒƒã‚¯ã‚¹ã®å®Ÿéš›ã®å€¤ã‚’å‚ç…§ï¼ˆå‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒæ§˜ï¼‰
        const voiceSelect = container.querySelector('select');
        const currentVoice = voiceSelect ? voiceSelect.value : '';
        // data-editedå±æ€§ã‚’å‚ç…§
        const dataEdited = container.dataset.edited || 'false';
        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å€¤
        const textarea = container.querySelector('textarea');
        const textVal = textarea ? textarea.value : '';
        // éŸ³å£°ãƒ•ã‚£ãƒ«ã‚¿
        let visible = true;
        if (voiceVal && currentVoice !== voiceVal) visible = false;
        // ç·¨é›†çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆdata-editedï¼‰
        if (editStateVal === 'true' && dataEdited !== 'true') visible = false;
        if (editStateVal === 'false' && dataEdited !== 'false') visible = false;
        // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
        if (searchVal && !textVal.includes(searchVal)) visible = false;
        if (visible) {
          container.style.display = '';
          container.dataset.visible = 'true';
        } else {
          container.style.display = 'none';
          container.dataset.visible = 'false';
        }
      });
    }
    filterSelect.addEventListener('change', applyVoiceFilter);
    searchInput.addEventListener('input', applyVoiceFilter);
    editStateSelect.addEventListener('change', applyVoiceFilter);

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆUIå†æç”»æ™‚ã«ã‚‚ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ã‚’å†é©ç”¨
    const _origRenderSegmentsUI = renderSegmentsUI;
    renderSegmentsUI = function(segmentsData) {
      _origRenderSegmentsUI(segmentsData);
      updateVoiceFilterOptions();
      applyVoiceFilter();
    };

    // MP3ç”Ÿæˆæ™‚ã«ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã€Œã™ã¹ã¦ã€ã«ãƒªã‚»ãƒƒãƒˆ
    const _origGenerateBtnHandler = generateBtn.onclick;
    generateBtn.addEventListener('click', () => {
      filterSelect.value = '';
      updateVoiceFilterOptions();
      applyVoiceFilter();
    });
  </script>
<!-- TextMidChangeè¡Œæ“ä½œé–¢æ•° -->
<script>
window.insertTMCrow = function(idx, fillText = '') {
  // Poolã«ã¯è¿½åŠ ä½ç½®ä»¥é™ã®è¡Œã ã‘ã‚’è¨˜æ†¶
  window._debugPool = window.TextMidChange.slice(idx).map(row => Array.isArray(row) ? [...row] : []);
  // è¿½åŠ è¡Œã‚’fillTextã§åŸ‹ã‚ã‚‹ï¼ˆ0ç•ªç›®ã®ã¿ã€1ã€œ9ç•ªç›®ã¯ç©ºï¼‰
  const newRow = [fillText, '', '', '', '', '', '', '', '', ''];
  // TextMidChangeã‚’å†æ§‹ç¯‰
  const upper = window.TextMidChange.slice(0, idx);
  const lower = window._debugPool;
  window.TextMidChange.length = 0;
  for (let i = 0; i < upper.length; i++) window.TextMidChange.push([...upper[i]]);
  window.TextMidChange.push(newRow);
  for (let i = 0; i < lower.length; i++) window.TextMidChange.push([...lower[i]]);
  if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
};

window.deleteTMCrow = function(idx) {
  window._debugPool = window.TextMidChange.map(row => Array.isArray(row) ? [...row] : []);
  const pool = window._debugPool;
  let newTextMidChange = [];
  const rowCount = pool.length;
  for (let i = 0; i < rowCount - 1; i++) {
    if (i < idx) {
      newTextMidChange[i] = [...pool[i]];
    } else {
      newTextMidChange[i] = [...pool[i + 1]];
    }
  }
  window.TextMidChange.length = 0;
  for (let i = 0; i < newTextMidChange.length; i++) {
    window.TextMidChange.push(newTextMidChange[i]);
  }
  if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
};
</script>
</body>
</html>
