<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Kusaikoid(ä»®)</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      align-items: flex-start;
    }
    #sidebarToggle {
      position: fixed;
      top: 0.5em;
      left: 0;
      background: #333;
      color: white;
      padding: 0.5em 1em;
      cursor: pointer;
      z-index: 1001;
    }
    #sidebar {
      width: 320px;
      background: #f0f0f0;
      padding: 1em;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      transition: transform 0.3s ease-in-out;
      overflow-y: auto;
      position: fixed;
      left: 0;
      top: 0;
      height: 100vh;
      z-index: 1000;
    }
    /* #sidebar.bottom { ä¸‹è¡¨ç¤ºã¯ç„¡åŠ¹åŒ–ï¼ˆå¸¸ã«å·¦å›ºå®šï¼‰ } */
    #sidebar.closed {
      transform: translateX(-100%);
    }
    #main {
      flex: 1;
      padding: 2em;
      overflow-y: auto;
      margin-left: 335px; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®å¹…åˆ†ã ã‘å³ã«ãšã‚‰ã™ï¼ˆé–‹æ™‚ï¼‰ */
      transition: margin-left 0.3s;
    }
    #sidebar.closed ~ #main {
      margin-left: 0 !important; /* ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‰æ™‚ã¯å·¦å¯„ã› */
    }
    textarea, select {
      margin-bottom: 0.5em;
      padding: 0.5em;
    }
    textarea {
      width: 100%;
    }
    select {
      min-width: 150px;
    }
    button {
      padding: 0.5em 1em;
      margin-right: 0.5em;
      border: none;
      border-radius: 4px;
      background-color: #007bff;
      color: white;
      cursor: pointer;
    }

    /* ã‚»ã‚°ãƒ¡ãƒ³ãƒˆæ“ä½œãƒœã‚¿ãƒ³ç”¨ã®ç™½è‰²ã‚¹ã‚¿ã‚¤ãƒ« */
    #segmentsAudioList .segment-controls button {
      background-color: #fff;
      color: #333;
      border: 1px solid #bbb;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      background-color: #aaa;
    }
    #regenerateBtn {
      background-color: #d9534f;
    }
    #segmentsAudioList > div {
      margin-bottom: 1em;
    }
    #segmentsAudioList .segment-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5em;
      margin-top: 0.5em;
    }
    #segmentsAudioList textarea {
      width: 100%;
      resize: vertical;
    }
    .sectionTitle {
      margin-top: 1em;
      font-weight: bold;
    }
    #changeNotice {
      color: #d9534f;
      font-weight: bold;
      margin-top: 0.5em;
      display: none;
    }

    /* ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #fileButtons {
      position: absolute;
      top: 0.5em;
      right: 0;
      display: flex;
      align-items: center;
      z-index: 1002;
    }
    
    #fileToggle {
      background: #666;
      color: white;
      border: none;
      padding: 0.5em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1.2em;
      transition: all 0.3s ease;
    }
    
    #fileToggle:hover {
      background: #555;
    }
    
    #fileActions {
      display: flex;
      gap: 0.5em;
      margin-right: 0.5em;
      opacity: 0;
      transform: translateX(20px);
      transition: all 0.3s ease;
      pointer-events: none;
    }
    
    #fileActions.expanded {
      opacity: 1;
      transform: translateX(0);
      pointer-events: auto;
    }
    
    #fileActions button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 0.5em;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
      transition: background 0.2s ease;
    }
    
    #saveBtn {
      background: #4CAF50;
    }
    
    #loadBtn {
      background: #2196F3;
    }
    
    #saveBtn:hover {
      background: #45a049;
    }
    
    #loadBtn:hover {
      background: #1976D2;
    }

    /* å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .right-sidebar {
      position: fixed;
      top: 0;
      right: 0;
      width: 630px;
      min-width: 630px;
      max-width: 100vw;
      height: 100vh;
      background: #f8f8f8;
      box-shadow: -2px 0 5px rgba(0,0,0,0.15);
      z-index: 1050;
      padding: 0;
      display: flex;
      flex-direction: column;
      transition: transform 0.3s;
    }
    .right-sidebar.closed {
      transform: translateX(100%);
    }
    .tab-header {
      display: flex;
      border-bottom: 1px solid #ddd;
      background: #f4f4f4;
      height: 52px;
    }
    .tab-btn {
      flex: 1;
      min-width: 0;
      padding: 0 0.2em;
      border: none;
      background: none;
      font-size: 1.13em;
      cursor: pointer;
      outline: none;
      border-right: 1px solid #ddd;
      transition: background 0.2s, color 0.2s;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #555;
      font-weight: 500;
      letter-spacing: 0.05em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tab-btn:last-child {
      border-right: none;
    }
    .tab-btn.active {
      background: #fff;
      font-weight: bold;
      color: #007bff;
      border-bottom: 2.5px solid #007bff;
    }
    .tab-content {
      flex: 1;
      padding: 1.2em;
      background: #fff;
      overflow-y: auto;
    }

    /* âš™ãƒœã‚¿ãƒ³ */
    #settingsBtn {
      position: fixed;
      right: 2em;
      bottom: 2em;
      z-index: 1100;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      font-size: 2em;
      background: #fff;
      color: #333;
      border: 2px solid #bbb;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    #settingsBtn:active, #settingsBtn:focus {
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      border-color: #007bff;
      outline: none;
    }
    #settingsBtn:before {
      content: '';
      display: inline-block;
      vertical-align: middle;
      height: 100%;
    }

    /* çµ±åˆRedoãƒœã‚¿ãƒ³ */
    #globalRedoBtn {
      position: fixed;
      right: 4.5em;
      bottom: 2em;
      z-index: 1100;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      font-size: 2em;
      background: #fff;
      color: #333;
      border: 2px solid #bbb;
      box-shadow: 0 2px 8px rgba(0,0,0,0.18);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    #globalRedoBtn:active, #globalRedoBtn:focus {
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      border-color: #007bff;
      outline: none;
    }
    #globalRedoBtn:before {
      content: '';
      display: inline-block;
      vertical-align: middle;
      height: 100%;
    }
  </style>
</head>
<body>

  <!-- ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
  <div id="debugMenuContainer" style="position:fixed;top:0;left:50%;transform:translateX(-50%);z-index:2000;background:#222;color:#fff;padding:0.5em 1em 1em 1em;border-radius:0 0 8px 8px;box-shadow:0 2px 8px rgba(0,0,0,0.18);display:none;min-width:320px;max-width:90vw;">
    <label style="font-weight:bold;cursor:pointer;">
      <input type="checkbox" id="debugMenuToggle" style="vertical-align:middle;margin-right:0.5em;">ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
    </label>
    <div style="margin-top:0.5em;">
      <button id="debugTabTextMidChange" style="margin-right:0.5em;">TextMidChange</button>
      <button id="debugTabPool" style="margin-right:0.5em;">Pool</button>
      <button id="debugTabChanged" style="margin-right:0.5em;">Changed</button>
      <button id="debugTabDPool">DPool</button>
    </div>
    <div id="debugMenuContent" style="margin-top:0.7em;max-height:300px;overflow:auto;font-size:0.95em;background:#333;padding:0.7em;border-radius:6px;display:none;"></div>
  </div>
  <script>
    // ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®è¡¨ç¤ºåˆ‡æ›¿
    const debugMenuContainer = document.getElementById('debugMenuContainer');
    const debugMenuToggle = document.getElementById('debugMenuToggle');
    const debugMenuContent = document.getElementById('debugMenuContent');
    // ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ç®¡ç†
    let debugMenuVisible = false; // åˆæœŸã¯éè¡¨ç¤º
    
    // Ctrl+Shift+Dã§ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.key === 'D') {
        e.preventDefault();
        debugMenuVisible = !debugMenuVisible;
        debugMenuContainer.style.display = debugMenuVisible ? 'block' : 'none';
        if (debugMenuVisible && debugMenuToggle.checked) {
          updateDebugMenu();
        }
      }
    });
    
    debugMenuToggle.addEventListener('change', () => {
      debugMenuContent.style.display = debugMenuToggle.checked ? 'block' : 'none';
      if (debugMenuToggle.checked) updateDebugMenu();
    });

    // Poolã®å†…å®¹ã‚’ä¸€æ™‚çš„ã«ä¿æŒã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    window._debugPool = null;

    // TextMidChangeã¾ãŸã¯Poolã®å†…å®¹ã‚’è¡¨ç¤º
    function updateDebugMenu() {
      if (!window.TextMidChange) return;
      const now = new Date();
      let html = '';
      const activeTab = window._debugTab || 'TextMidChange';
      if (activeTab === 'TextMidChange') {
        html += `<b>TextMidChangeï¼ˆè¡Œ:ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ, åˆ—:å±¥æ­´ï¼‰</b> <span style='font-size:0.9em;color:#8ff;'>(æ›´æ–°: ${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3,'0')})</span><br>`;
        html += '<table border="1" style="border-collapse:collapse;font-size:0.95em;background:#222;color:#fff;width:100%;min-width:700px;table-layout:fixed;">';
        html += '<thead><tr><th style="width:40px;">è¡Œ</th>';
        for (let j = 0; j < 10; j++) html += `<th style="width:120px;">${j+1}</th>`;
        html += '</tr></thead><tbody>';
        for (let i = 0; i < TextMidChange.length; i++) {
          html += `<tr><td style="font-weight:bold;">${i}</td>`;
          for (let j = 0; j < 10; j++) {
            html += `<td style="max-width:180px;overflow-wrap:anywhere;min-width:80px;">${TextMidChange[i] && typeof TextMidChange[i][j] !== 'undefined' ? TextMidChange[i][j] : ''}</td>`;
          }
          html += '</tr>';
        }
        html += '</tbody></table>';
      } else if (activeTab === 'Pool') {
        html += `<b>Poolï¼ˆç›´è¿‘ã®è¡Œãƒ»åˆ—æ“ä½œæ™‚ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰</b> <span style='font-size:0.9em;color:#8ff;'>(æ›´æ–°: ${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3,'0')})</span><br>`;
        if (window._debugPool) {
          html += '<table border="1" style="border-collapse:collapse;font-size:0.95em;background:#222;color:#fff;width:100%;min-width:700px;table-layout:fixed;">';
          html += '<thead><tr><th style="width:40px;">è¡Œ</th>';
          for (let j = 0; j < 10; j++) html += `<th style="width:120px;">${j+1}</th>`;
          html += '</tr></thead><tbody>';
          for (let i = 0; i < window._debugPool.length; i++) {
            html += `<tr><td style="font-weight:bold;">${i}</td>`;
            for (let j = 0; j < 10; j++) {
              html += `<td style="max-width:180px;overflow-wrap:anywhere;min-width:80px;">${window._debugPool[i] && typeof window._debugPool[i][j] !== 'undefined' ? window._debugPool[i][j] : ''}</td>`;
            }
            html += '</tr>';
          }
          html += '</tbody></table>';
        } else {
          html += '<span style="color:#faa;">Poolã¯ã¾ã è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</span>';
        }
      } else if (activeTab === 'Changed') {
        html += `<b>Changedï¼ˆçµ±åˆMP3å†ç”Ÿæˆæ™‚ã®æœ€æ–°çŠ¶æ…‹ï¼‰</b> <span style='font-size:0.9em;color:#8ff;'>(æ›´æ–°: ${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3,'0')})</span><br>`;
        html += `<span style='color:#ccc;'>è¡Œæ•°: ${window.Changed.length}</span><br>`;
        if (window.Changed.length > 0) {
          html += '<table border="1" style="border-collapse:collapse;font-size:0.95em;background:#222;color:#fff;width:100%;min-width:500px;">';
          html += '<thead><tr><th style="width:40px;">è¡Œ</th><th style="width:300px;">ãƒ†ã‚­ã‚¹ãƒˆ</th><th style="width:80px;">å£°</th><th style="width:100px;">éµ</th></tr></thead><tbody>';
          for (let i = 0; i < window.Changed.length; i++) {
            const item = window.Changed[i];
            html += `<tr><td style="font-weight:bold;">${i}</td>`;
            html += `<td style="max-width:300px;overflow-wrap:anywhere;">${item.text || ''}</td>`;
            html += `<td>${item.vid || ''}</td>`;
            html += `<td style="font-size:0.8em;">${item.ttsboxId || ''}</td>`;
            html += '</tr>';
          }
          html += '</tbody></table>';
        } else {
          html += '<span style="color:#faa;">Changedã¯ç©ºã§ã™ã€‚</span>';
        }
      } else if (activeTab === 'DPool') {
        html += `<b>DPoolï¼ˆå‰Šé™¤ã•ã‚ŒãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆå±¥æ­´ï¼‰</b> <span style='font-size:0.9em;color:#8ff;'>(æ›´æ–°: ${now.toLocaleTimeString()}.${now.getMilliseconds().toString().padStart(3,'0')})</span><br>`;
        html += `<span style='color:#ccc;'>ä»¶æ•°: ${DPool.length}/20</span><br>`;
        if (DPool.length > 0) {
          html += '<div style="margin-bottom:0.5em;"><button onclick="revertAllFromDPool()" style="background:#d9534f;color:white;border:none;padding:0.3em 0.8em;border-radius:4px;cursor:pointer;">å…¨å·®ã—æˆ»ã—</button></div>';
          html += '<table border="1" style="border-collapse:collapse;font-size:0.95em;background:#222;color:#fff;width:100%;min-width:600px;">';
          html += '<thead><tr><th style="width:40px;">No.</th><th style="width:60px;">å…ƒä½ç½®</th><th style="width:250px;">ãƒ†ã‚­ã‚¹ãƒˆ</th><th style="width:80px;">å£°</th><th style="width:80px;">æ¬¡ã®éµ</th><th style="width:80px;">æ“ä½œ</th></tr></thead><tbody>';
          for (let i = 0; i < DPool.length; i++) {
            const item = DPool[i];
            html += `<tr><td style="font-weight:bold;">${i+1}</td>`;
            html += `<td>${item.index}</td>`;
            html += `<td style="max-width:250px;overflow-wrap:anywhere;">${item.segment.text || ''}</td>`;
            html += `<td>${item.segment.vid || ''}</td>`;
            html += `<td>${item.nextKey || 'ãªã—'}</td>`;
            html += `<td><button onclick="revertSingleFromDPool(${i})" style="background:#007bff;color:white;border:none;padding:0.2em 0.5em;border-radius:3px;cursor:pointer;font-size:0.8em;">å¾©å…ƒ</button></td>`;
            html += '</tr>';
          }
          html += '</tbody></table>';
        } else {
          html += '<span style="color:#faa;">DPoolã¯ç©ºã§ã™ã€‚</span>';
        }
      }
      debugMenuContent.innerHTML = html;
    }
    // TextMidChangeæ›´æ–°æ™‚ã«ãƒ‡ãƒãƒƒã‚°å†…å®¹ã‚‚æ›´æ–°
    window.updateDebugMenu = updateDebugMenu;

    // ãƒ‡ãƒãƒƒã‚°ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    window._debugTab = 'TextMidChange';
    document.addEventListener('DOMContentLoaded', () => {
      const tab1 = document.getElementById('debugTabTextMidChange');
      const tab2 = document.getElementById('debugTabPool');
      const tab3 = document.getElementById('debugTabChanged');
      const tab4 = document.getElementById('debugTabDPool');
      if (tab1 && tab2 && tab3 && tab4) {
        tab1.onclick = () => { window._debugTab = 'TextMidChange'; updateDebugMenu(); };
        tab2.onclick = () => { window._debugTab = 'Pool'; updateDebugMenu(); };
        tab3.onclick = () => { window._debugTab = 'Changed'; updateDebugMenu(); };
        tab4.onclick = () => { window._debugTab = 'DPool'; updateDebugMenu(); };
      }
      
      // DPoolãƒœã‚¿ãƒ³ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
      updateGlobalRedoButton();
      
      // èª¬æ˜æ›¸ã‚¿ãƒ–ã®å†…å®¹ã‚’è¨­å®š
      const descTab = document.getElementById('tab-desc');
      if (descTab) {
        descTab.innerHTML = `
          <div style="padding: 1em; font-size: 1.2em; line-height: 1.6;">
            <h3 style="margin-top: 0; border-bottom: 2px solid #ddd; padding-bottom: 0.5em;font-size: 2.0em;">KUSAIKOID ver.beta5.0</h3>
            
            <h4>åŸºæœ¬çš„ãªä½¿ã„æ–¹</h4>
            <ol>
              <li><strong>ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›</strong>: å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›</li>
              <li><strong>éŸ³å£°ç”Ÿæˆ</strong>: ã€ŒMP3ã‚’ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã§ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ†å‰²ï¼‹éŸ³å£°ç”Ÿæˆ</li>
              <li><strong>ç·¨é›†</strong>: å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆã‚„éŸ³å£°ã‚’å€‹åˆ¥ã«ç·¨é›†å¯èƒ½</li>
              <li><strong>å†ç”Ÿæˆ</strong>: ç·¨é›†å¾Œã¯ã€Œç·¨é›†å¾Œã®MP3ã‚’å†ç”Ÿæˆã€ã§çµ±åˆéŸ³å£°ã‚’æ›´æ–°</li>
            </ol>
            
            <h4>ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½</h4>
            <p><strong>ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿</strong>: å·¦ä¸Šã®ğŸ“ãƒœã‚¿ãƒ³ã‹ã‚‰å±•é–‹</p>
            <ul>
              <li><strong>ğŸ’¾ ä¿å­˜</strong>: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã‚’JSONãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿å­˜</li>
              <li><strong>ğŸ“‚ èª­ã¿è¾¼ã¿</strong>: 
                <ul>
                  <li><strong>JSONãƒ•ã‚¡ã‚¤ãƒ«</strong>: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œå…¨å¾©å…ƒ</li>
                  <li><strong>TXTãƒ•ã‚¡ã‚¤ãƒ«</strong>: å°æœ¬å½¢å¼ï¼ˆVID:ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‹ã‚‰èª­ã¿è¾¼ã¿</li>
                </ul>
              </li>
            </ul>

            <h4>ğŸ“ å°æœ¬å½¢å¼ï¼ˆTXTãƒ•ã‚¡ã‚¤ãƒ«ï¼‰</h4>
            <p>ä»¥ä¸‹ã®å½¢å¼ã§ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã¨èª­ã¿è¾¼ã¿å¯èƒ½:</p>
            <pre style="background: #f5f5f5; padding: 0.5em; border-radius: 4px; font-size: 0.8em;">2:æ‹“ä¹Ÿã®å°„ç²¾ã€€3000å††
# ã‚³ãƒ¡ãƒ³ãƒˆè¡Œï¼ˆ#ã§å§‹ã¾ã‚‹è¡Œã¯ç„¡è¦–ã•ã‚Œã¾ã™ï¼‰</pre>
            <h4>ğŸ¤ éŸ³å£°IDï¼ˆVIDï¼‰ä¸€è¦§</h4>
            <ul style="columns: 2; column-gap: 1em;">
              <li><strong>VID:2</strong> - æ‹“ä¹Ÿã•ã‚“ / CV.SHOW</li>
              <li><strong>VID:3</strong> - MISAKI</li>
              <li><strong>VID:4</strong> - SAYAKA</li>
              <li><strong>VID:5</strong> - HIKARI</li>
              <li><strong>VID:6</strong> - ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ / CV.HARUKA</li>
              <li><strong>VID:7</strong> - RYO</li>
              <li><strong>VID:8</strong> - ãƒ¬ã‚ª / CV.TAKERU</li>
            </ul>
            
            <h4>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆç·¨é›†</h4>
            <ul>
              <li><strong>ğŸ”Š å†ç”Ÿ</strong>: å€‹åˆ¥ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéŸ³å£°ã®å†ç”Ÿ</li>
              <li><strong>â†º/â†»</strong>: ãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´ã®æˆ»ã‚‹ãƒ»é€²ã‚€ï¼ˆæœ€å¤§10ä»¶ï¼‰</li>
              <li><strong>éŸ³å£°é¸æŠ</strong>: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã«ç•°ãªã‚‹éŸ³å£°ã‚’é¸æŠå¯èƒ½</li>
              <li><strong>ğŸ—‘ï¸ å‰Šé™¤</strong>: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå‰Šé™¤ï¼ˆå‰Šé™¤ãƒ—ãƒ¼ãƒ«ã«ä¿å­˜ï¼‰</li>
              <li><strong>ï¼‹ä¸Š/ï¼‹ä¸‹</strong>: æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¸Šä¸‹ã«æŒ¿å…¥</li>
            </ul>
            
            <h4>å±¥æ­´ãƒ»å¾©å…ƒæ©Ÿèƒ½</h4>
            <ul>
              <li><strong>ç·¨é›†å±¥æ­´</strong>: å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ã‚’æœ€å¤§10ä»¶è¨˜éŒ²</li>
              <li><strong>å‰Šé™¤ãƒ—ãƒ¼ãƒ«</strong>: å‰Šé™¤ã—ãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’æœ€å¤§20ä»¶ä¿å­˜</li>
              <li><strong>â†ºãƒœã‚¿ãƒ³</strong>: å‰Šé™¤ãƒ—ãƒ¼ãƒ«ã‹ã‚‰ã®ä¸€æ‹¬å¾©å…ƒ</li>
              <li><strong>çŠ¶æ…‹è¨ºæ–­</strong>: ç·¨é›†çŠ¶æ…‹ã‚’è‡ªå‹•åˆ¤å®šãƒ»è¡¨ç¤º</li>
            </ul>
            
            <h4>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ©Ÿèƒ½</h4>
            <ul>
              <li><strong>éŸ³å£°ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</strong>: ç‰¹å®šã®éŸ³å£°ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ã¿è¡¨ç¤º</li>
              <li><strong>ç·¨é›†çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</strong>: ç·¨é›†æ¸ˆã¿/æœªç·¨é›†ã§çµã‚Šè¾¼ã¿</li>
              <li><strong>ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢</strong>: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†…å®¹ã§ã®æ¤œç´¢</li>
            </ul>
            
            <h4>ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½</h4>
            <p><strong>Ctrl+Shift+D</strong>: ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºï¼ˆå†…éƒ¨çŠ¶æ…‹ç¢ºèªç”¨ï¼‰</p>
            
            <h4>æ³¨æ„äº‹é …</h4>
            <ul>
              <li>éŸ³å£°ç”Ÿæˆã«ã¯ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¿…è¦ã§ã™</li>
              <li>å¤§é‡ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã¯ç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™</li>
              <li>5-10å›ã®éŸ³å£°ç”Ÿæˆã”ã¨ã«7-10ç§’ã®ä¼‘æ­¢ãŒå…¥ã‚Šã¾ã™</li>
              <li>ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒªãƒ­ãƒ¼ãƒ‰ã§æœªä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™</li>
            </ul>
          </div>
        `;
      }
    });

    // åŠ›æŠ€: ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹é–“ã¯1ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°
    setInterval(() => {
      if (debugMenuToggle.checked) updateDebugMenu();
    }, 1000);
    
    // DPoolã®å·®ã—æˆ»ã—æ©Ÿèƒ½
    window.revertSingleFromDPool = function(index) {
      if (index >= 0 && index < DPool.length) {
        const item = DPool[index];
        
        // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å¾©å…ƒ
        let insertIndex = 0;
        if (item.nextKey) {
          const targetIndex = currentSegments.findIndex(seg => seg.ttsboxId === item.nextKey);
          if (targetIndex !== -1) {
            insertIndex = targetIndex;
          } else {
            insertIndex = Math.min(item.index, currentSegments.length);
          }
        } else {
          insertIndex = currentSegments.length;
        }
        
        currentSegments.splice(insertIndex, 0, item.segment);
        window.insertTMCrow(insertIndex, item.segment.text);
        if (item.history && item.history.length > 0) {
          window.TextMidChange[insertIndex] = [...item.history];
        }
        
        // DPoolã‹ã‚‰å‰Šé™¤
        DPool.splice(index, 1);
        
        regenerateBtn.disabled = false;
        updateChangeNotice();
        renderSegmentsUI(currentSegments);
        updateVoiceFilterOptions();
        updateGlobalRedoButton();
        if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
      }
    };
    
    window.revertAllFromDPool = function() {
      if (DPool.length === 0) return;
      
      const confirmRevert = confirm(`DPoolã®å…¨${DPool.length}é …ç›®ã‚’å·®ã—æˆ»ã—ã¾ã™ã‹ï¼Ÿ\næ—¢å­˜ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã«å½±éŸ¿ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`);
      if (!confirmRevert) return;
      
      // é€†é †ã§å¾©å…ƒï¼ˆå¾Œã§å‰Šé™¤ã•ã‚ŒãŸã‚‚ã®ã‹ã‚‰å…ˆã«å¾©å…ƒï¼‰
      while (DPool.length > 0) {
        const item = DPool.pop();
        
        let insertIndex = 0;
        if (item.nextKey) {
          const targetIndex = currentSegments.findIndex(seg => seg.ttsboxId === item.nextKey);
          if (targetIndex !== -1) {
            insertIndex = targetIndex;
          } else {
            insertIndex = Math.min(item.index, currentSegments.length);
          }
        } else {
          insertIndex = currentSegments.length;
        }
        
        currentSegments.splice(insertIndex, 0, item.segment);
        window.insertTMCrow(insertIndex, item.segment.text);
        if (item.history && item.history.length > 0) {
          window.TextMidChange[insertIndex] = [...item.history];
        }
      }
      
      regenerateBtn.disabled = false;
      updateChangeNotice();
      renderSegmentsUI(currentSegments);
      updateVoiceFilterOptions();
      updateGlobalRedoButton();
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
    };
  </script>
  <div id="sidebarToggle">â‰¡ å…¥åŠ›</div>
  <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ä½ç½®åˆ‡æ›¿ãƒœã‚¿ãƒ³ã¯ä¸è¦ãªã®ã§å‰Šé™¤ -->

  <div id="sidebar" class="">
    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ -->
    <div id="fileButtons">
      <div id="fileActions">
        <button id="saveBtn">ğŸ’¾</button>
        <button id="loadBtn">ğŸ“‚</button>
      </div>
      <button id="fileToggle">ğŸ“</button>
    </div>
    
    <br>
    <h2>éŸ³å£°ç”Ÿæˆ</h2>
    <label for="voiceSelect">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å£°:</label>
    <select id="voiceSelect">
      <option value="2">æ‹“ä¹Ÿã•ã‚“ / CV.SHOW</option>
      <option value="3">MISAKI</option>
      <option value="4">SAYAKA</option>
      <option value="5">HIKARI</option>
      <option value="6">ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ / CV.HARUKA</option>
      <option value="7">RYO</option>
      <option value="8">ãƒ¬ã‚ª / CV.TAKERU</option>
    </select>
    <br>
    <label for="textInput">ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›:</label>
    <textarea id="textInput" rows="10">ã€Œã‚¯ãƒªã‚¹ãƒã‚¹ãƒ»ã‚¤ãƒ–ã¯ï¼“æ—¥é–“ãã‚‰ã„ã‚ã‚‹ã¨ã„ã„ã‚“ã ã‚ˆã­ã€‚ã ã£ã¦ã•ãã€ã‚¤ãƒ´ã®æ—¥ã¨ã‹ã«ä¸€äººã®ã‚ªãƒ³ãƒŠã®å­ã¨ã‹ã„ã£ã±ã„ã„ã¦ã‹ã‚ã„ãã†ã˜ã‚ƒã‚“ï¼ã€ãªã‚“ã¦è¨€ã£ã¦ã„ãªãŒã‚‰ã€ã‚ªãƒ¬ã«ã¨ã£ã¦ã®æœ¬å‘½ãã‚“ãŒã¯ãŸã—ã¦ã‚¤ãƒ–ã«å‘¼ã‚“ã§ãã‚Œã‚‹ã‹ã©ã†ã‹ã‚„ã£ã±ã‚Šæ°—ã«ãªã‚‹ã€‚æœ¬å‘½ã‚¯ãƒ³ã¯æ±ºã—ã¦çµ¶å¯¾ã«ç´„æŸãªã‚“ã‹ã—ã¦ãã‚Œãªã„ã€‚ã ã‹ã‚‰ã‚ªãƒ¬ã¯ã‚°ãƒ¬ã¾ãã£ã¦ã‚¦ãƒªãªã‚“ã‹ã‚„ã£ã¦ã„ã‚‹ã€‚ãã‚Œã«çµ¶å¯¾æ±ºã—ã¦ã€Œå¥½ãã ã€ãªã‚“ã¦è¨€ã£ã¦ãã‚Œãªã„ã€‚å˜ãªã‚‹ã€Œãƒšãƒƒãƒˆã€ã¨ã—ã¦æ„›ã—ã¦ãã‚Œã¦ã„ã‚‹ã ã‘ã ã€‚</textarea>
    <div id="charCount">0æ–‡å­—</div>

    <button id="generateBtn">MP3ã‚’ç”Ÿæˆ</button>
    <button id="regenerateBtn" disabled>ç·¨é›†å¾Œã®MP3ã‚’å†ç”Ÿæˆ</button>

    <div class="sectionTitle">çµ±åˆéŸ³å£°</div>
    <div id="result"></div>
    <button id="downloadBtn" disabled>MP3ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    <div id="changeNotice">å¤‰æ›´ç‚¹ãŒæ›´æ–°ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</div>
  </div>

  <div id="main">
    <br>
    <div class="sectionTitle">å˜æ–‡åˆ¥éŸ³å£°</div>
    <div id="segmentsAudioList"></div>
  </div>

  <!-- å³ä¸‹ã®âš™ãƒœã‚¿ãƒ³ -->
  <button id="settingsBtn">âš™</button>

  <!-- çµ±åˆRedoãƒœã‚¿ãƒ³ -->
  <button id="globalRedoBtn">â†º</button>

  <!-- å³ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
  <div id="rightSidebar" class="right-sidebar">
    <div class="tab-header">
      <button class="tab-btn active" data-tab="tab-desc">èª¬æ˜æ›¸</button>
      <button class="tab-btn" data-tab="tab-filter">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼</button>
      <button class="tab-btn" data-tab="tab-batch">ãƒãƒƒãƒæ“ä½œ</button>
      <button class="tab-btn" data-tab="tab-segment">ç²¾æ–‡åŒ–</button>
      <button class="tab-btn" data-tab="tab-download">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </div>
    <div class="tab-content" id="tab-desc" style="display:block;"></div>
    <div class="tab-content" id="tab-filter" style="display:none;"></div>
    <div class="tab-content" id="tab-batch" style="display:none;"></div>
    <div class="tab-content" id="tab-segment" style="display:none;"></div>
    <div class="tab-content" id="tab-download" style="display:none;"></div>
  </div>

  <script>
    // ====== DOMè¦ç´ å–å¾— ======
    const generateBtn = document.getElementById('generateBtn'); // MP3ç”Ÿæˆãƒœã‚¿ãƒ³
    const regenerateBtn = document.getElementById('regenerateBtn'); // å†ç”Ÿæˆãƒœã‚¿ãƒ³
    const textInput = document.getElementById('textInput'); // å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
    const charCount = document.getElementById('charCount'); // æ–‡å­—æ•°è¡¨ç¤º
    const resultDiv = document.getElementById('result'); // çµ±åˆéŸ³å£°è¡¨ç¤ºã‚¨ãƒªã‚¢
    const downloadBtn = document.getElementById('downloadBtn'); // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
    const segmentsAudioList = document.getElementById('segmentsAudioList'); // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆéŸ³å£°ãƒªã‚¹ãƒˆ
    const sidebar = document.getElementById('sidebar'); // ã‚µã‚¤ãƒ‰ãƒãƒ¼
    const toggle = document.getElementById('sidebarToggle'); // ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰ãƒœã‚¿ãƒ³
    const defaultVoiceSelect = document.getElementById("voiceSelect"); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå£°é¸æŠ
    const changeNotice = document.getElementById('changeNotice'); // å¤‰æ›´é€šçŸ¥
    const settingsBtn = document.getElementById('settingsBtn'); // âš™ãƒœã‚¿ãƒ³
    const globalRedoBtn = document.getElementById('globalRedoBtn'); // çµ±åˆRedoãƒœã‚¿ãƒ³
    const rightSidebar = document.getElementById('rightSidebar'); // å³ã‚µã‚¤ãƒ‰ãƒãƒ¼

    // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³
    const fileToggle = document.getElementById('fileToggle');
    const fileActions = document.getElementById('fileActions');
    const saveBtn = document.getElementById('saveBtn');
    const loadBtn = document.getElementById('loadBtn');

    // ====== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ======
    let finalBlobURL = null; // çµ±åˆéŸ³å£°ã®Blob URL
    let currentSegments = []; // ç¾åœ¨ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé…åˆ—
    // TextMidChange: [è¡Œ][å±¥æ­´] å½¢å¼ã®2æ¬¡å…ƒé…åˆ—ã€‚å„è¡Œã¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã€å„åˆ—ã¯å±¥æ­´ï¼ˆ1ãŒç›´å‰ã€æœ€å¤§10ä»¶ï¼‰
    window.TextMidChange = [];
    // Changedè¡Œåˆ—: çµ±åˆMP3å†ç”Ÿæˆæ™‚ã®å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æœ€æ–°çŠ¶æ…‹ã‚’ä¿å­˜
    window.Changed = [];
    // DPool: å‰Šé™¤ã•ã‚ŒãŸã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¨˜æ†¶ï¼ˆæœ€å¤§20ä»¶ï¼‰
    let DPool = [];
    
    // ãƒ©ãƒ³ãƒ€ãƒ ãªæ–‡å­—åˆ—ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    function generateRandomKey(length = 8) {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let result = '';
      for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }
    
    // æ™‚åˆ»éµã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆç¾åœ¨æ™‚åˆ»ã®ç§’æ•° Ã— 114.514ï¼‰
    function generateTimeKey() {
      const now = Date.now();
      const seconds = Math.floor(now / 1000);
      const timeKey = Math.floor(seconds * 114.514);
      return timeKey.toString();
    }
    
    // æ–‡å­—éµã¨æ™‚åˆ»éµã‚’ä½µç”¨ã—ãŸè¤‡åˆéµã‚’ç”Ÿæˆ
    function generateHybridKey() {
      const randomPart = generateRandomKey(6); // 6æ–‡å­—ã®ãƒ©ãƒ³ãƒ€ãƒ æ–‡å­—åˆ—
      const timePart = generateTimeKey(); // æ™‚åˆ»éµ
      return `${randomPart}-${timePart}`;
    }

    // DPoolãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    function updateGlobalRedoButton() {
        const globalRedoBtn = document.getElementById('globalRedoBtn');
        if (globalRedoBtn) {
            if (DPool.length === 0) {
                globalRedoBtn.style.opacity = '0.3';
                globalRedoBtn.style.cursor = 'not-allowed';
            } else {
                globalRedoBtn.style.opacity = '1';
                globalRedoBtn.style.cursor = 'pointer';
            }
        }
    }

    // ====== ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰ ======
    toggle.addEventListener('click', () => {
      sidebar.classList.toggle('closed');
      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é–‹é–‰ã«å¿œã˜ã¦#mainã®margin-leftã‚’èª¿æ•´
      const main = document.getElementById('main');
      if (sidebar.classList.contains('closed')) {
        main.style.marginLeft = '0';
      } else {
        main.style.marginLeft = '335px';
      }
    });

    // ====== ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ ======
    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒœã‚¿ãƒ³ã®å±•é–‹ãƒ»åç´
    fileToggle.addEventListener('click', () => {
      fileActions.classList.toggle('expanded');
    });

    // ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆJSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
    saveBtn.addEventListener('click', () => {
      // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ã‚’ä½œæˆ
      const saveData = {
        version: "1.0",
        timestamp: new Date().toISOString(),
        inputText: textInput.value,
        defaultVoice: defaultVoiceSelect.value,
        currentSegments: currentSegments,
        textMidChange: window.TextMidChange,
        changed: window.Changed,
        dPool: DPool
      };
      
      // JSONãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const dataStr = JSON.stringify(saveData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      
      // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆï¼ˆæ—¥æ™‚ä»˜ãï¼‰
      const now = new Date();
      const fileName = `kusaikoid_project_${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}.json`;
      
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // ãƒ•ã‚¡ã‚¤ãƒ«ãƒœã‚¿ãƒ³ã‚’é–‰ã˜ã‚‹
      fileActions.classList.remove('expanded');
      
      console.log('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', fileName);
    });

    // èª­ã¿è¾¼ã¿ãƒœã‚¿ãƒ³ï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã¾ãŸã¯ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼‰
    loadBtn.addEventListener('click', () => {
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠç”¨ã®inputè¦ç´ ã‚’ä½œæˆ
      const fileInput = document.createElement('input');
      fileInput.type = 'file';
      fileInput.accept = '.json,.txt';
      fileInput.style.display = 'none';
      
      fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const text = await file.text();
          
          // ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­ã§åˆ¤å®š
          if (file.name.toLowerCase().endsWith('.json')) {
            // JSONãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ï¼ˆæ—¢å­˜ã®å‡¦ç†ï¼‰
            const saveData = JSON.parse(text);
            
            // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
            if (!saveData.version) {
              throw new Error('ç„¡åŠ¹ãªãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
            if (saveData.inputText !== undefined) {
              textInput.value = saveData.inputText;
              charCount.textContent = `${textInput.value.length} æ–‡å­—`;
            }
            
            if (saveData.defaultVoice !== undefined) {
              defaultVoiceSelect.value = saveData.defaultVoice;
            }
            
            if (saveData.currentSegments) {
              currentSegments = saveData.currentSegments;
            }
            
            if (saveData.textMidChange) {
              window.TextMidChange = saveData.textMidChange;
            }
            
            if (saveData.changed) {
              window.Changed = saveData.changed;
            }
            
            if (saveData.dPool) {
              DPool = saveData.dPool;
            }
            
            console.log('JSONãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', file.name);
            console.log('èª­ã¿è¾¼ã¿æ—¥æ™‚:', saveData.timestamp);
            
          } else if (file.name.toLowerCase().endsWith('.txt')) {
            // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†ï¼ˆVID:ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼‰
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const segments = [];
            
            for (const line of lines) {
              // ã‚³ãƒ¡ãƒ³ãƒˆè¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
              if (line.startsWith('#')) continue;
              
              // VID:ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã®è§£æ
              const match = line.match(/^(\d+):(.+)$/);
              if (match) {
                const vid = match[1];
                const segmentText = match[2].trim();
                
                // VIDãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ2-8ã®ç¯„å›²ï¼‰
                if (vid >= '2' && vid <= '8') {
                  segments.push({
                    text: segmentText,
                    vid: vid,
                    ttsboxId: generateHybridKey()
                  });
                } else {
                  console.warn(`ç„¡åŠ¹ãªVID: ${vid} (è¡Œ: ${line})`);
                }
              } else {
                console.warn(`ç„¡åŠ¹ãªå½¢å¼ã®è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—: ${line}`);
              }
            }
            
            if (segments.length === 0) {
              throw new Error('æœ‰åŠ¹ãªã‚»ã‚°ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚VID:ãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚');
            }
            
            // ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentSegments = segments;
            window.TextMidChange = [];
            window.Changed = [];
            DPool = [];
            
            // å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
            textInput.value = '';
            charCount.textContent = '0 æ–‡å­—';
            
            console.log(`ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ${file.name} (${segments.length}ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ)`);
            
          } else {
            throw new Error('ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚JSONã¾ãŸã¯TXTãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          }
          
          // UIã‚’å†æç”»
          if (currentSegments.length > 0) {
            renderSegmentsUI(currentSegments);
            updateVoiceFilterOptions();
            
            // èª­ã¿è¾¼ã¿å¾Œã«è‡ªå‹•çš„ã«MP3ã‚’å†ç”Ÿæˆ
            console.log('èª­ã¿è¾¼ã¿å®Œäº†å¾Œã€MP3ã‚’è‡ªå‹•å†ç”Ÿæˆã—ã¾ã™...');
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰MP3å†ç”Ÿæˆã‚’å®Ÿè¡Œï¼ˆUIã®æç”»ãŒå®Œäº†ã™ã‚‹ã¾ã§ï¼‰
            setTimeout(async () => {
              try {
                await generateAudioFromSegments(currentSegments);
                regenerateBtn.disabled = true;
                updateChangeNotice();
                console.log('MP3ã®è‡ªå‹•å†ç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸ');
              } catch (error) {
                console.error('MP3è‡ªå‹•å†ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                alert('MP3ã®è‡ªå‹•å†ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
              }
            }, 100);
          }
          
          // DPoolãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
          updateGlobalRedoButton();
          
          // ãƒ‡ãƒãƒƒã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’æ›´æ–°
          if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) {
            window.updateDebugMenu();
          }
          
          // ãƒ•ã‚¡ã‚¤ãƒ«ãƒœã‚¿ãƒ³ã‚’é–‰ã˜ã‚‹
          fileActions.classList.remove('expanded');
          
        } catch (error) {
          console.error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
          alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        }
        
        // inputè¦ç´ ã‚’å‰Šé™¤
        document.body.removeChild(fileInput);
      });
      
      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      document.body.appendChild(fileInput);
      fileInput.click();
    });

    // ä»–ã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒœã‚¿ãƒ³ã‚’é–‰ã˜ã‚‹
    document.addEventListener('click', (e) => {
      if (!fileToggle.contains(e.target) && !fileActions.contains(e.target)) {
        fileActions.classList.remove('expanded');
      }
    });

    // ====== å…¥åŠ›æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆ ======
    textInput.addEventListener('input', () => {
      charCount.textContent = `${textInput.value.length} æ–‡å­—`;
    });
    charCount.textContent = `${textInput.value.length} æ–‡å­—`;

    // ====== å¤‰æ›´é€šçŸ¥ã®è¡¨ç¤ºåˆ¶å¾¡ ======
    function updateChangeNotice() {
      if (!regenerateBtn.disabled) {
        changeNotice.style.display = 'block';
      } else {
        changeNotice.style.display = 'none';
      }
    }



    /**
     * TTSï¼ˆãƒ†ã‚­ã‚¹ãƒˆèª­ã¿ä¸Šã’ï¼‰ç”¨ã®URLã‚’ç”Ÿæˆã™ã‚‹
     * @param {string} vid - å£°ã®ID
     * @param {string} text - èª­ã¿ä¸Šã’ã‚‹ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string} - ç”Ÿæˆã•ã‚ŒãŸTTSãƒªã‚¯ã‚¨ã‚¹ãƒˆURL
     */
    function generateTTSURL(vid, text) {
      // ç‰¹æ®Šæ–‡å­—ã‚’APIã§èª­ã‚ã‚‹å½¢ã«ç½®æ›
      const sanitized = text.replace(/&/g, 'ã‚¢ãƒ³ãƒ‰').replace(/=/g, 'ã‚¤ã‚³ãƒ¼ãƒ«');
      return `https://cache-a.oddcast.com/tts/genC.php?EID=3&LID=12&VID=${vid}&TXT=${encodeURIComponent(sanitized)}&EXT=mp3&FNAME=&ACC=15679&SceneID=2646118&HTTP_ERR=`;
    }


    /**
     * ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–‡ã”ã¨ã«åˆ†å‰²ã™ã‚‹ï¼ˆã€‚ï¼ï¼Ÿã§åŒºåˆ‡ã‚‹ï¼‰
     * @param {string} text - å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
     * @returns {string[]} - æ–‡ã”ã¨ã®é…åˆ—
     */
    function splitTextBySentence(text) {
      // æ­£è¦è¡¨ç¾ã§æ–‡æœ«ï¼ˆã€‚ï¼ï¼Ÿï¼‰ã”ã¨ã«åˆ†å‰²
      const sentences = text.match(/[^ã€‚ï¼ï¼Ÿ\r\n]*[ã€‚ï¼ï¼Ÿ]?/g) || [];
      return sentences.map(s => s.trim()).filter(Boolean);
    }


    /**
     * æŒ‡å®šURLã‹ã‚‰MP3ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆBlobï¼‰ã‚’å–å¾—ã™ã‚‹
     * @param {string} url - MP3ãƒ•ã‚¡ã‚¤ãƒ«ã®URL
     * @returns {Promise<Blob>} - å–å¾—ã—ãŸMP3ã®Blob
     */
    async function fetchMP3Blob(url) {
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã«å¤±æ•—");
      return await res.blob();
    }




/**
 * ã‚»ã‚°ãƒ¡ãƒ³ãƒˆUIã®ã¿ã‚’å³æ™‚æç”»ï¼ˆéŸ³å£°ã¯å†ç”Ÿæˆæ™‚ã®ã¿å–å¾—ï¼‰
 * @param {Array<{text: string, vid: string}>} segmentsData
 */
function renderSegmentsUI(segmentsData) {
  segmentsAudioList.innerHTML = '';
  
  // Changedãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆåˆå›è¡¨ç¤ºæ™‚ã‚„æ–°è¦ç”Ÿæˆæ™‚ï¼‰
  if (window.Changed.length === 0) {
    window.Changed = [];
    for (let i = 0; i < segmentsData.length; i++) {
      window.Changed.push({
        text: segmentsData[i].text,
        vid: segmentsData[i].vid,
        ttsboxId: segmentsData[i].ttsboxId || generateHybridKey()
      });
    }
  }
  
  // Poolã®ä¿å­˜ã¯å„æ“ä½œé–¢æ•°å†…ã§è¡Œã†ãŸã‚ã€ã“ã“ã§ã¯ä¿å­˜ã—ãªã„
  // TextMidChangeã®è¡Œæ•°ã‚’segmentsDataã«åˆã‚ã›ã¦èª¿æ•´
  while (TextMidChange.length < segmentsData.length) TextMidChange.push([]);
  while (TextMidChange.length > segmentsData.length) TextMidChange.pop();
  // æ—¢å­˜è¡Œã¯ä¸Šæ›¸ãã—ãªã„ã€‚ç©ºè¡Œã®ã¿åˆæœŸåŒ–ã€‚
  for (let i = 0; i < segmentsData.length; i++) {
    if (!TextMidChange[i] || TextMidChange[i].length === 0) {
      TextMidChange[i] = [segmentsData[i].text, '', '', '', '', '', '', '', '', ''];
    }
  }
  if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
  segmentsData.forEach((seg, i) => {
    // ttsboxãƒ©ãƒƒãƒ‘ãƒ¼div
    const ttsbox = document.createElement('div');
    ttsbox.className = 'ttsbox';
    ttsbox.dataset.voice = seg.vid || '';
    ttsbox.dataset.selected = seg.selected === true ? 'true' : 'false';
    ttsbox.dataset.visible = seg.visible === false ? 'false' : 'true';
    ttsbox.dataset.column = i; // åˆ—ç•ªå·ã‚’data-columnå±æ€§ã§ä»˜ä¸
    
    // å„ttsboxã«ä¸€æ„IDã‚’ä»˜ä¸ï¼ˆéµã‚·ã‚¹ãƒ†ãƒ ï¼‰
    if (!seg.ttsboxId) {
      seg.ttsboxId = generateHybridKey();
    }
    ttsbox.dataset.ttsboxId = seg.ttsboxId;

    // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
    const textarea = document.createElement('textarea');
    textarea.rows = 2;
    textarea.value = seg.text;
    textarea.dataset.index = i;
    
    // å…¥åŠ›ä¸­ã¯å¤‰æ›´ãƒ•ãƒ©ã‚°ã®ã¿ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ã«å†ç”Ÿæˆ
    textarea.oninput = () => {
      seg.text = textarea.value.trim();
      regenerateBtn.disabled = false;
      updateChangeNotice();
    };
    textarea.onblur = async () => {
      // ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿å†ç”Ÿæˆ
      if (!regenerateBtn.disabled) {
        // TextMidChangeã‚‚ã“ã“ã§æ›´æ–°ï¼ˆ0åˆ—ç›®ã¯å¸¸ã«æœ€æ–°ãƒ†ã‚­ã‚¹ãƒˆï¼‰
        seg.text = textarea.value.trim();
        if (!TextMidChange[i]) TextMidChange[i] = [];
        
        if (currentHistoryIndex === 0) {
          // æœ€æ–°å±¥æ­´ã‹ã‚‰ç·¨é›†ã—ãŸå ´åˆã¯é€šå¸¸ã®å‡¦ç†
          if (TextMidChange[i][0] !== seg.text) {
            TextMidChange[i].unshift(seg.text);
          } else {
            TextMidChange[i][0] = seg.text;
          }
        } else {
          // éæœ€æ–°å±¥æ­´ã‹ã‚‰ç·¨é›†ã—ãŸå ´åˆã¯0ç•ªç›®ã‚’ä¸Šæ›¸ã
          TextMidChange[i][0] = seg.text;
        }
        
        // 0åˆ—ç›®ä»¥å¤–ã®é‡è¤‡ã‚’é™¤å»
        for (let k = 1; k < TextMidChange[i].length; k++) {
          if (TextMidChange[i][k] === seg.text) {
            TextMidChange[i].splice(k, 1);
            k--;
          }
        }
        if (TextMidChange[i].length > 10) TextMidChange[i].length = 10;
        
        // ç¾åœ¨ã®å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
        currentHistoryIndex = 0;
        
        if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
        
        // ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¦data-editedã‚’æ›´æ–°
        diagnoseAndUpdateEditedState(ttsbox, i);
        
        // å€‹åˆ¥ç·¨é›†æ™‚ã¯çµ±åˆéŸ³å£°ã®å†ç”Ÿæˆã¯è¡Œã‚ãšã€å†ç”Ÿæˆãƒœã‚¿ãƒ³ã§å¯¾å¿œ
        // await generateAudioFromSegments(segmentsData);
        // regenerateBtn.disabled = true;
        // updateChangeNotice();
      }
    };

    // ãƒœã‚¤ã‚¹ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹
    const voiceSelect = defaultVoiceSelect.cloneNode(true);
    voiceSelect.removeAttribute('id');
    voiceSelect.title = 'éŸ³å£°ã®ç¨®é¡ã‚’é¸æŠ';
    voiceSelect.value = seg.vid;
    voiceSelect.onchange = async () => {
      console.log(`Voice changed from ${seg.vid} to ${voiceSelect.value} for segment index ${i}`);
      seg.vid = voiceSelect.value;
      // ttsboxã®data-voiceã‚‚æ›´æ–°
      ttsbox.dataset.voice = voiceSelect.value;
      regenerateBtn.disabled = false;
      updateChangeNotice();
      
      console.log('About to call updateVoiceFilterOptions() after voice change');
      // éŸ³å£°å¤‰æ›´æ™‚ã«å³åº§ã«ãƒ•ã‚£ãƒ«ã‚¿ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
      updateVoiceFilterOptions();
      applyVoiceFilter();
      console.log('updateVoiceFilterOptions() and applyVoiceFilter() completed');
      
      // ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¦data-editedã‚’æ›´æ–°
      diagnoseAndUpdateEditedState(ttsbox, i);
      
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
    };

    // å†ç”Ÿãƒœã‚¿ãƒ³ï¼ˆUIã®ã¿ã€ç„¡åŠ¹åŒ–ï¼‰
    const playButton = document.createElement('button');
    playButton.textContent = 'ğŸ”Š å†ç”Ÿ';
    playButton.title = 'ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®éŸ³å£°ã‚’å†ç”Ÿ';
    playButton.disabled = true;

    // ç¾åœ¨ã®å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½è·¡
    let currentHistoryIndex = 0;

    // æˆ»ã™ãƒœã‚¿ãƒ³ï¼ˆTextMidChangeã‹ã‚‰å±¥æ­´ã‚’å‘¼ã³æˆ»ã™ï¼‰
    const restoreButton = document.createElement('button');
    restoreButton.textContent = 'â†º';
    restoreButton.title = 'ãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´ã‹ã‚‰æˆ»ã™';
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    const updateRestoreButtonState = () => {
      const canUndo = TextMidChange[i] && TextMidChange[i].length > 1 && 
                     currentHistoryIndex + 1 < TextMidChange[i].length && 
                     currentHistoryIndex + 1 < 10 && 
                     TextMidChange[i][currentHistoryIndex + 1] && 
                     TextMidChange[i][currentHistoryIndex + 1] !== '' &&
                     TextMidChange[i][currentHistoryIndex + 1] !== textarea.value;
      
      if (canUndo) {
        restoreButton.style.opacity = '1';
        restoreButton.disabled = false;
      } else {
        restoreButton.style.opacity = '0.3';
        restoreButton.disabled = true;
      }
    };
    
    restoreButton.onclick = () => {
      if (restoreButton.disabled) return;
      
      const nextIndex = currentHistoryIndex + 1;
      const previousText = TextMidChange[i][nextIndex];
      textarea.value = previousText;
      seg.text = previousText;
      currentHistoryIndex = nextIndex;
      
      regenerateBtn.disabled = false;
      updateChangeNotice();
      updateRestoreButtonState();
      updateRedoButtonState();
      
      // ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¦data-editedã‚’æ›´æ–°
      diagnoseAndUpdateEditedState(ttsbox, i);
    };

    // ã‚„ã‚Šç›´ã—ãƒœã‚¿ãƒ³ï¼ˆTextMidChangeã‹ã‚‰é€²ã‚“ã å±¥æ­´ã‚’å‘¼ã³æˆ»ã™ï¼‰
    const redoButton = document.createElement('button');
    redoButton.textContent = 'â†»';
    redoButton.title = 'ãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´ã‚’ã‚„ã‚Šç›´ã™';
    
    const updateRedoButtonState = () => {
      const canRedo = TextMidChange[i] && currentHistoryIndex > 0 && 
                     TextMidChange[i][currentHistoryIndex - 1] && 
                     TextMidChange[i][currentHistoryIndex - 1] !== '' &&
                     TextMidChange[i][currentHistoryIndex - 1] !== textarea.value;
      
      if (canRedo) {
        redoButton.style.opacity = '1';
        redoButton.disabled = false;
      } else {
        redoButton.style.opacity = '0.3';
        redoButton.disabled = true;
      }
    };
    
    redoButton.onclick = () => {
      if (redoButton.disabled) return;
      
      const nextIndex = currentHistoryIndex - 1;
      const nextText = TextMidChange[i][nextIndex];
      textarea.value = nextText;
      seg.text = nextText;
      currentHistoryIndex = nextIndex;
      
      regenerateBtn.disabled = false;
      updateChangeNotice();
      updateRestoreButtonState();
      updateRedoButtonState();
      
      // ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¦data-editedã‚’æ›´æ–°
      diagnoseAndUpdateEditedState(ttsbox, i);
    };
    
    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    updateRestoreButtonState();
    updateRedoButtonState();

    // ã‚´ãƒŸç®±ãƒœã‚¿ãƒ³
    const deleteButton = document.createElement('button');
    deleteButton.textContent = 'ğŸ—‘ï¸';
    deleteButton.title = 'ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤';
    deleteButton.onclick = () => {
      // å‰Šé™¤ã•ã‚Œã‚‹è¦ç´ ã®æ¬¡ã®è¦ç´ ã«éµã‚’ä¸ãˆã‚‹
      const nextSibling = ttsbox.nextElementSibling;
      let nextKey = null;
      if (nextSibling && nextSibling.dataset.ttsboxId) {
        nextKey = nextSibling.dataset.ttsboxId;
      }
      
      // DPoolã«å‰Šé™¤ã•ã‚Œã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜
      const deletedSegment = {
        segment: { ...segmentsData[i] },
        index: i,
        history: window.TextMidChange[i] ? [...window.TextMidChange[i]] : [segmentsData[i].text],
        nextKey: nextKey // å¾©å…ƒæ™‚ã®ç›®å°ã¨ãªã‚‹éµ
      };
      DPool.push(deletedSegment);
      
      // DPoolã®æœ€å¤§ã‚µã‚¤ã‚ºã‚’20ã«åˆ¶é™
      if (DPool.length > 20) {
        DPool.shift();
      }
      
      segmentsData.splice(i, 1);
      window.deleteTMCrow(i);
      regenerateBtn.disabled = false;
      updateChangeNotice();
      renderSegmentsUI(segmentsData);
      updateVoiceFilterOptions();
      updateGlobalRedoButton(); // DPoolãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
    };

    // ä¸Šä¸‹è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã‚’ä½¿ç”¨ï¼‰
    const insertAboveButton = document.createElement('button');
    insertAboveButton.textContent = 'ï¼‹ä¸Š';
    insertAboveButton.title = 'ã“ã®ä¸Šã«æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
    insertAboveButton.onclick = () => {
      const newSegments = segmentsData.slice(0, i)
        .concat([{ text: 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚', vid: seg.vid, ttsboxId: generateHybridKey() }])
        .concat(segmentsData.slice(i));
      window.insertTMCrow(i, 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚');
      regenerateBtn.disabled = false;
      updateChangeNotice();
      renderSegmentsUI(newSegments);
      updateVoiceFilterOptions();
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
      currentSegments = newSegments;
    };
    const insertBelowButton = document.createElement('button');
    insertBelowButton.textContent = 'ï¼‹ä¸‹';
    insertBelowButton.title = 'ã“ã®ä¸‹ã«æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
    insertBelowButton.onclick = () => {
      const newSegments = segmentsData.slice(0, i + 1)
        .concat([{ text: 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚', vid: seg.vid, ttsboxId: generateHybridKey() }])
        .concat(segmentsData.slice(i + 1));
      window.insertTMCrow(i + 1, 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚');
      regenerateBtn.disabled = false;
      updateChangeNotice();
      renderSegmentsUI(newSegments);
      updateVoiceFilterOptions();
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
      currentSegments = newSegments;
    };

    // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœãƒƒã‚¯ã‚¹
    const controls = document.createElement('div');
    controls.className = 'segment-controls';
    controls.append(playButton, restoreButton, redoButton, voiceSelect, deleteButton, insertAboveButton, insertBelowButton);

    // ttsboxã«è¦ç´ ã‚’ã¾ã¨ã‚ã¦è¿½åŠ 
    ttsbox.append(textarea, controls);
    segmentsAudioList.appendChild(ttsbox);
  });
  
  // åˆæœŸè¡¨ç¤ºæ™‚ã«å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­
  const allTtsboxes = segmentsAudioList.querySelectorAll('.ttsbox');
  allTtsboxes.forEach((ttsbox, index) => {
    diagnoseAndUpdateEditedState(ttsbox, index);
  });
  
  updateVoiceFilterOptions();
}

/**
 * ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã”ã¨ã«éŸ³å£°ã‚’ç”Ÿæˆã—ã€UIã«åæ˜ ã™ã‚‹
 * @param {Array<{text: string, vid: string}>} segmentsData - å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ãƒ†ã‚­ã‚¹ãƒˆã¨å£°ID
 */
async function generateAudioFromSegments(segmentsData) {
  // --- 1. UIåˆæœŸåŒ– ---
  resultDiv.textContent = 'ç”Ÿæˆä¸­...';
  if (finalBlobURL) {
    URL.revokeObjectURL(finalBlobURL);
    finalBlobURL = null;
  }
  downloadBtn.disabled = true;
  // --- 2. å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®éŸ³å£°ã‚’å…ˆã«å…¨ã¦å–å¾— ---
  const mergedBlobs = [];
  const segmentBlobs = [];
  let ttsCount = 0;
  // 5ï½10å›ã”ã¨ã«7ï½10ç§’ä¼‘æ­¢
  let ttsLimit = Math.floor(Math.random() * 6) + 5; // 5ï½10
  for (let i = 0; i < segmentsData.length; i++) {
    const seg = segmentsData[i];
    const url = generateTTSURL(seg.vid, seg.text);
    try {
      const blob = await fetchMP3Blob(url);
      segmentBlobs.push(blob);
      mergedBlobs.push(blob);
    } catch {
      segmentBlobs.push(null);
      mergedBlobs.push(new Blob());
    }
    ttsCount++;
    if (ttsCount >= ttsLimit && i < segmentsData.length - 1) {
      // 7ï½10ç§’ä¼‘æ­¢
      const sleepMs = (Math.floor(Math.random() * 4) + 7) * 1000; // 7ï½10ç§’
      await new Promise(res => setTimeout(res, sleepMs));
      ttsCount = 0;
      ttsLimit = Math.floor(Math.random() * 6) + 5; // 5ï½10
    }
  }
  // --- 3. UIç”Ÿæˆï¼ˆéŸ³å£°å–å¾—å¾Œãªã®ã§å†ç”Ÿãƒœã‚¿ãƒ³ã¯å¿…ãšå‹•ãï¼‰ ---
  segmentsAudioList.innerHTML = '';
  
  // Changedãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–ï¼ˆåˆå›è¡¨ç¤ºæ™‚ã‚„æ–°è¦ç”Ÿæˆæ™‚ï¼‰
  if (window.Changed.length === 0) {
    window.Changed = [];
    for (let i = 0; i < segmentsData.length; i++) {
      window.Changed.push({
        text: segmentsData[i].text,
        vid: segmentsData[i].vid,
        ttsboxId: segmentsData[i].ttsboxId || generateHybridKey()
      });
    }
  }
  
  // TextMidChangeã®è¡Œæ•°ã‚’segmentsDataã«åˆã‚ã›ã¦èª¿æ•´
  while (TextMidChange.length < segmentsData.length) TextMidChange.push([]);
  while (TextMidChange.length > segmentsData.length) TextMidChange.pop();
  // åˆå›ã¾ãŸã¯è¡ŒæŒ¿å…¥æ™‚ã¯10åˆ—ç›®ã¾ã§åŸ‹ã‚ã‚‹
  for (let i = 0; i < segmentsData.length; i++) {
    if (!TextMidChange[i] || TextMidChange[i].length === 0) {
      TextMidChange[i] = [segmentsData[i].text, '', '', '', '', '', '', '', '', ''];
    }
  }
  segmentsData.forEach((seg, i) => {
    // ttsboxãƒ©ãƒƒãƒ‘ãƒ¼div
    const ttsbox = document.createElement('div');
    ttsbox.className = 'ttsbox';
    ttsbox.dataset.voice = seg.vid || '';
    ttsbox.dataset.selected = seg.selected === true ? 'true' : 'false';
    ttsbox.dataset.visible = seg.visible === false ? 'false' : 'true';
    
    // å„ttsboxã«ä¸€æ„IDã‚’ä»˜ä¸ï¼ˆéµã‚·ã‚¹ãƒ†ãƒ ï¼‰
    if (!seg.ttsboxId) {
      seg.ttsboxId = generateHybridKey();
    }
    ttsbox.dataset.ttsboxId = seg.ttsboxId;

    const textarea = document.createElement('textarea');
    textarea.rows = 2;
    textarea.value = seg.text;
    textarea.dataset.index = i;
    
    let currentBlob = segmentBlobs[i];
    // --- TextMidChange: mp3æ›´æ–°æ™‚ã«å±¥æ­´ã‚’ä¿å­˜ ---
    if (!TextMidChange[i]) TextMidChange[i] = [];
    // textareaã®å€¤ï¼ˆæœ€æ–°ãƒ†ã‚­ã‚¹ãƒˆï¼‰ã‚’å±¥æ­´ã®å…ˆé ­ã«è¿½åŠ ï¼ˆé‡è¤‡ã¯è¿½åŠ ã—ãªã„ï¼‰
    const newText = seg.text;
    if (TextMidChange[i][0] !== newText) {
      TextMidChange[i].unshift(newText);
      if (TextMidChange[i].length > 10) TextMidChange[i].length = 10;
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
    }
    const controls = document.createElement('div');
    controls.className = 'segment-controls';
    const playButton = document.createElement('button');
    playButton.textContent = 'ğŸ”Š å†ç”Ÿ';
    playButton.title = 'ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®éŸ³å£°ã‚’å†ç”Ÿ';
    playButton.disabled = !currentBlob;
    playButton.onclick = () => {
      if (currentBlob) new Audio(URL.createObjectURL(currentBlob)).play();
    };
    const voiceSelect = defaultVoiceSelect.cloneNode(true);
    voiceSelect.removeAttribute('id');
    voiceSelect.title = 'éŸ³å£°ã®ç¨®é¡ã‚’é¸æŠ';
    voiceSelect.value = seg.vid;
    voiceSelect.onchange = async () => {
      seg.vid = voiceSelect.value;
      // ttsboxã®data-voiceã‚‚æ›´æ–°
      ttsbox.dataset.voice = voiceSelect.value;
      regenerateBtn.disabled = false;
      updateChangeNotice(); // å£°å¤‰æ›´æ™‚ã«ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ã‚‚æ›´æ–°
      updateVoiceFilterOptions();
      applyVoiceFilter();
      try {
        playButton.disabled = true;
        playButton.textContent = 'ç”Ÿæˆä¸­...';
        currentBlob = await fetchMP3Blob(generateTTSURL(voiceSelect.value, seg.text));
        playButton.textContent = 'ğŸ”Š å†ç”Ÿ';
        playButton.disabled = false;
        
        // MP3å†ç”Ÿæˆå®Œäº†å¾Œã«ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­
        diagnoseAndUpdateEditedState(ttsbox, i);
        
        // MP3å†ç”Ÿæˆå®Œäº†å¾Œã«ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ã‚’æ›´æ–°
        updateVoiceFilterOptions();
        applyVoiceFilter();
      } catch {
        playButton.textContent = 'ã‚¨ãƒ©ãƒ¼';
        playButton.disabled = true;
      }
    };
    // å…¥åŠ›ä¸­ã¯å¤‰æ›´ãƒ•ãƒ©ã‚°ã®ã¿ã€ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒå¤–ã‚ŒãŸæ™‚ã«å†ç”Ÿæˆ
    textarea.oninput = () => {
      seg.text = textarea.value.trim();
      regenerateBtn.disabled = false;
      updateChangeNotice();
    };
    textarea.onblur = async () => {
      if (!regenerateBtn.disabled) {
        // TextMidChangeã‚‚ã“ã“ã§æ›´æ–°ï¼ˆ0åˆ—ç›®ã¯å¸¸ã«æœ€æ–°ãƒ†ã‚­ã‚¹ãƒˆï¼‰
        seg.text = textarea.value.trim();
        if (!TextMidChange[i]) TextMidChange[i] = [];
        
        if (currentHistoryIndex === 0) {
          // æœ€æ–°å±¥æ­´ã‹ã‚‰ç·¨é›†ã—ãŸå ´åˆã¯é€šå¸¸ã®å‡¦ç†
          if (TextMidChange[i][0] !== seg.text) {
            TextMidChange[i].unshift(seg.text);
          } else {
            TextMidChange[i][0] = seg.text;
          }
        } else {
          // éæœ€æ–°å±¥æ­´ã‹ã‚‰ç·¨é›†ã—ãŸå ´åˆã¯0ç•ªç›®ã‚’ä¸Šæ›¸ã
          TextMidChange[i][0] = seg.text;
        }
        
        // 0åˆ—ç›®ä»¥å¤–ã®é‡è¤‡ã‚’é™¤å»
        for (let k = 1; k < TextMidChange[i].length; k++) {
          if (TextMidChange[i][k] === seg.text) {
            TextMidChange[i].splice(k, 1);
            k--;
          }
        }
        if (TextMidChange[i].length > 10) TextMidChange[i].length = 10;
        
        // ç¾åœ¨ã®å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
        currentHistoryIndex = 0;
        
        if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
        updateRestoreButtonState();
        updateRedoButtonState();
        try {
          playButton.disabled = true;
          playButton.textContent = 'ç”Ÿæˆä¸­...';
          currentBlob = await fetchMP3Blob(generateTTSURL(voiceSelect.value, seg.text));
          playButton.textContent = 'ğŸ”Š å†ç”Ÿ';
          playButton.disabled = false;
          
          // MP3å†ç”Ÿæˆå®Œäº†å¾Œã«ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­
          diagnoseAndUpdateEditedState(ttsbox, i);
          
          // MP3å†ç”Ÿæˆå®Œäº†å¾Œã«ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ã‚’æ›´æ–°
          updateVoiceFilterOptions();
          applyVoiceFilter();
        } catch {
          playButton.textContent = 'ã‚¨ãƒ©ãƒ¼';
          playButton.disabled = true;
        }
        // å€‹åˆ¥ç·¨é›†æ™‚ã¯çµ±åˆéŸ³å£°ã®å†ç”Ÿæˆã¯è¡Œã‚ãšã€å†ç”Ÿæˆãƒœã‚¿ãƒ³ã§å¯¾å¿œ
        // regenerateBtn.disabled = true;
        // updateChangeNotice();
      }
    };
    
    // ç¾åœ¨ã®å±¥æ­´ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¿½è·¡
    let currentHistoryIndex = 0;
    
    // æˆ»ã™ãƒœã‚¿ãƒ³ï¼ˆTextMidChangeã‹ã‚‰å±¥æ­´ã‚’å‘¼ã³æˆ»ã™ï¼‰
    const restoreButton = document.createElement('button');
    restoreButton.textContent = 'â†º';
    restoreButton.title = 'ãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´ã‹ã‚‰æˆ»ã™';
    
    // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    const updateRestoreButtonState = () => {
      const canUndo = TextMidChange[i] && TextMidChange[i].length > 1 && 
                     currentHistoryIndex + 1 < TextMidChange[i].length && 
                     currentHistoryIndex + 1 < 10 && 
                     TextMidChange[i][currentHistoryIndex + 1] && 
                     TextMidChange[i][currentHistoryIndex + 1] !== '' &&
                     TextMidChange[i][currentHistoryIndex + 1] !== textarea.value;
      
      if (canUndo) {
        restoreButton.style.opacity = '1';
        restoreButton.disabled = false;
      } else {
        restoreButton.style.opacity = '0.3';
        restoreButton.disabled = true;
      }
    };
    
    restoreButton.onclick = async () => {
      if (restoreButton.disabled) return;
      
      const nextIndex = currentHistoryIndex + 1;
      const previousText = TextMidChange[i][nextIndex];
      textarea.value = previousText;
      seg.text = previousText;
      currentHistoryIndex = nextIndex;
      
      regenerateBtn.disabled = false;
      updateChangeNotice();
      updateRestoreButtonState();
      updateRedoButtonState();
      
      // éŸ³å£°ã‚‚å†ç”Ÿæˆ
      try {
        playButton.disabled = true;
        playButton.textContent = 'ç”Ÿæˆä¸­...';
        currentBlob = await fetchMP3Blob(generateTTSURL(voiceSelect.value, seg.text));
        playButton.textContent = 'ğŸ”Š å†ç”Ÿ';
        playButton.disabled = false;
      } catch {
        playButton.textContent = 'ã‚¨ãƒ©ãƒ¼';
        playButton.disabled = true;
      }
    };

    // ã‚„ã‚Šç›´ã—ãƒœã‚¿ãƒ³ï¼ˆTextMidChangeã‹ã‚‰é€²ã‚“ã å±¥æ­´ã‚’å‘¼ã³æˆ»ã™ï¼‰
    const redoButton = document.createElement('button');
    redoButton.textContent = 'â†»';
    redoButton.title = 'ãƒ†ã‚­ã‚¹ãƒˆå±¥æ­´ã‚’ã‚„ã‚Šç›´ã™';
    
    const updateRedoButtonState = () => {
      const canRedo = TextMidChange[i] && currentHistoryIndex > 0 && 
                     TextMidChange[i][currentHistoryIndex - 1] && 
                     TextMidChange[i][currentHistoryIndex - 1] !== '' &&
                     TextMidChange[i][currentHistoryIndex - 1] !== textarea.value;
      
      if (canRedo) {
        redoButton.style.opacity = '1';
        redoButton.disabled = false;
      } else {
        redoButton.style.opacity = '0.3';
        redoButton.disabled = true;
      }
    };
    
    redoButton.onclick = async () => {
      if (redoButton.disabled) return;
      
      const nextIndex = currentHistoryIndex - 1;
      const nextText = TextMidChange[i][nextIndex];
      textarea.value = nextText;
      seg.text = nextText;
      currentHistoryIndex = nextIndex;
      
      regenerateBtn.disabled = false;
      updateChangeNotice();
      updateRestoreButtonState();
      updateRedoButtonState();
      
      // éŸ³å£°ã‚‚å†ç”Ÿæˆ
      try {
        playButton.disabled = true;
        playButton.textContent = 'ç”Ÿæˆä¸­...';
        currentBlob = await fetchMP3Blob(generateTTSURL(voiceSelect.value, seg.text));
        playButton.textContent = 'ğŸ”Š å†ç”Ÿ';
        playButton.disabled = false;
      } catch {
        playButton.textContent = 'ã‚¨ãƒ©ãƒ¼';
        playButton.disabled = true;
      }
    };
    
    // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    updateRestoreButtonState();
    updateRedoButtonState();
    
    const deleteButton = document.createElement('button');
    deleteButton.textContent = 'ğŸ—‘ï¸';
    deleteButton.title = 'ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤';
    deleteButton.onclick = async () => {
      // å‰Šé™¤ã•ã‚Œã‚‹è¦ç´ ã®æ¬¡ã®è¦ç´ ã«éµã‚’ä¸ãˆã‚‹
      const nextSibling = ttsbox.nextElementSibling;
      let nextKey = null;
      if (nextSibling && nextSibling.dataset.ttsboxId) {
        nextKey = nextSibling.dataset.ttsboxId;
      }
      
      // DPoolã«å‰Šé™¤ã•ã‚Œã‚‹ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’ä¿å­˜
      const deletedSegment = {
        segment: { ...segmentsData[i] },
        index: i,
        history: window.TextMidChange[i] ? [...window.TextMidChange[i]] : [segmentsData[i].text],
        nextKey: nextKey // å¾©å…ƒæ™‚ã®ç›®å°ã¨ãªã‚‹éµ
      };
      DPool.push(deletedSegment);
      
      // DPoolã®æœ€å¤§ã‚µã‚¤ã‚ºã‚’20ã«åˆ¶é™
      if (DPool.length > 20) {
        DPool.shift();
      }
      
      segmentsData.splice(i, 1);
      window.deleteTMCrow(i);
      regenerateBtn.disabled = false;
      updateChangeNotice();
      renderSegmentsUI(segmentsData);
      updateVoiceFilterOptions(); // å‰Šé™¤æ™‚ã‚‚æ›´æ–°
      updateGlobalRedoButton(); // DPoolãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    };
    const insertAboveButton = document.createElement('button');
    insertAboveButton.textContent = 'ï¼‹ä¸Š';
    insertAboveButton.title = 'ã“ã®ä¸Šã«æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
    insertAboveButton.onclick = async () => {
      segmentsData.splice(i, 0, { text: 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚', vid: seg.vid, ttsboxId: generateHybridKey() });
      window.insertTMCrow(i, 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚');
      regenerateBtn.disabled = false;
      updateChangeNotice();
      renderSegmentsUI(segmentsData);
      updateVoiceFilterOptions(); // æŒ¿å…¥æ™‚ã‚‚æ›´æ–°
    };
    const insertBelowButton = document.createElement('button');
    insertBelowButton.textContent = 'ï¼‹ä¸‹';
    insertBelowButton.title = 'ã“ã®ä¸‹ã«æ–°ã—ã„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ';
    insertBelowButton.onclick = async () => {
      segmentsData.splice(i + 1, 0, { text: 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚', vid: seg.vid, ttsboxId: generateHybridKey() });
      window.insertTMCrow(i + 1, 'ãƒ†ã‚­ã‚¹ãƒˆã‚’æŒ¿å…¥ã€‚');
      regenerateBtn.disabled = false;
      updateChangeNotice();
      renderSegmentsUI(segmentsData);
      updateVoiceFilterOptions(); // æŒ¿å…¥æ™‚ã‚‚æ›´æ–°
    };
    controls.append(playButton, restoreButton, redoButton, voiceSelect, deleteButton, insertAboveButton, insertBelowButton);
    // ttsboxã«ã¾ã¨ã‚ã¦è¿½åŠ 
    ttsbox.append(textarea, controls);
    segmentsAudioList.appendChild(ttsbox);
  });
  
  // åˆæœŸè¡¨ç¤ºæ™‚ã«å…¨ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­
  const allTtsboxes = segmentsAudioList.querySelectorAll('.ttsbox');
  allTtsboxes.forEach((ttsbox, index) => {
    diagnoseAndUpdateEditedState(ttsbox, index);
  });
  
  updateVoiceFilterOptions(); // UIç”Ÿæˆå¾Œã«ã‚‚å¿…ãšå‘¼ã¶
  // --- 4. çµ±åˆéŸ³å£°ã®ç”Ÿæˆãƒ»UIåæ˜  ---
  finalBlobURL = URL.createObjectURL(new Blob(mergedBlobs, { type: 'audio/mp3' }));
  resultDiv.textContent = '';
  const audio = document.createElement('audio');
  audio.controls = true;
  audio.src = finalBlobURL;
  resultDiv.appendChild(audio);
  downloadBtn.disabled = false;
  regenerateBtn.disabled = true;
  updateChangeNotice();
}



    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®ç·¨é›†çŠ¶æ…‹ã‚’è¨ºæ–­ã—ã¦data-editedã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function diagnoseAndUpdateEditedState(ttsbox, segmentIndex) {
        const textarea = ttsbox.querySelector('textarea');
        if (!textarea || !window.Changed || segmentIndex >= window.Changed.length) {
            return;
        }
        
        const currentText = textarea.value.trim();
        const changedText = window.Changed[segmentIndex]?.text || '';
        const isEdited = currentText !== changedText;
        
        ttsbox.dataset.edited = isEdited ? 'true' : 'false';
    }

    // ====== MP3ç”Ÿæˆãƒœã‚¿ãƒ³ ======
    generateBtn.addEventListener('click', async () => {
      const rawText = textInput.value.trim();
      const defaultVid = defaultVoiceSelect.value;
      if (!rawText) {
        alert("ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }
      
      // å±¥æ­´ãƒªã‚»ãƒƒãƒˆã®è­¦å‘Š
      if (window.TextMidChange.length > 0 || window.Changed.length > 0) {
        const confirmReset = confirm("æ–°ã—ã„MP3ã‚’ç”Ÿæˆã™ã‚‹ã¨ã€æ—¢å­˜ã®ç·¨é›†å±¥æ­´ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ã€‚\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ");
        if (!confirmReset) {
          return;
        }
      }
      
      // å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆ
      window.TextMidChange = [];
      window.Changed = [];
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–‡ã”ã¨ã«åˆ†å‰²ã—ã€ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé…åˆ—ã‚’ä½œæˆï¼ˆè¤‡åˆéµã‚‚ä»˜ä¸ï¼‰
      const segments = splitTextBySentence(rawText).map(txt => ({ 
        text: txt, 
        vid: defaultVid,
        ttsboxId: generateHybridKey()
      }));
      currentSegments = segments;
      // ã¾ãšUIã®ã¿å³æ™‚æç”»ã›ãšã€åˆå›ã‹ã‚‰éŸ³å£°ç”Ÿæˆã¾ã§è¡Œã†
      await generateAudioFromSegments(currentSegments);
      regenerateBtn.disabled = true;
      updateChangeNotice();
    });

    // ====== å†ç”Ÿæˆãƒœã‚¿ãƒ³ ======
    regenerateBtn.addEventListener('click', async () => {
      // currentSegmentsã‚‚åŒæœŸæ›´æ–°
      const allTtsboxes = document.querySelectorAll('.ttsbox');
      allTtsboxes.forEach((ttsbox, index) => {
        const textarea = ttsbox.querySelector('textarea');
        const voiceSelect = ttsbox.querySelector('select');
        if (textarea && voiceSelect && currentSegments[index]) {
          currentSegments[index].text = textarea.value.trim();
          currentSegments[index].vid = voiceSelect.value;
        }
      });
      
      await generateAudioFromSegments(currentSegments);
      regenerateBtn.disabled = true;
      updateChangeNotice();
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
    });

    // ====== ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ ======
    downloadBtn.addEventListener('click', () => {
      if (!finalBlobURL) return;
      const a = document.createElement('a');
      a.href = finalBlobURL;
      a.download = 'merged_audio.mp3';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // åˆæœŸè¡¨ç¤ºæ™‚ã¯ã‚»ã‚°ãƒ¡ãƒ³ãƒˆUIã‚’æç”»ã—ãªã„ï¼ˆmp3ç”Ÿæˆæ™‚ã®ã¿ç”Ÿæˆï¼‰

    // å³ä¸‹âš™ãƒœã‚¿ãƒ³ã§å³ã‚µã‚¤ãƒ‰ãƒãƒ¼é–‹é–‰
    settingsBtn.addEventListener('click', () => {
      rightSidebar.classList.toggle('closed');
    });

    // çµ±åˆRedoãƒœã‚¿ãƒ³ã®å‡¦ç†
    globalRedoBtn.addEventListener('click', () => {
      // DPoolã‹ã‚‰ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å¾©å…ƒ
      if (DPool.length === 0) {
        return; // å¾©å…ƒã™ã‚‹ã‚‚ã®ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
      }
      
      const deletedItem = DPool.pop(); // æœ€å¾Œã«å‰Šé™¤ã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã‚’å–å¾—
      let insertIndex = 0;
      
      // éµã‚’ä½¿ã£ã¦å¾©å…ƒä½ç½®ã‚’ç‰¹å®š
      if (deletedItem.nextKey) {
        // æ¬¡ã®è¦ç´ ã®éµã‚’æ¢ã™
        const targetIndex = currentSegments.findIndex(seg => seg.ttsboxId === deletedItem.nextKey);
        if (targetIndex !== -1) {
          insertIndex = targetIndex;
        } else {
          // éµãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨
          insertIndex = Math.min(deletedItem.index, currentSegments.length);
        }
      } else {
        // æœ€å¾Œã®è¦ç´ ã ã£ãŸå ´åˆã¯æœ«å°¾ã«è¿½åŠ 
        insertIndex = currentSegments.length;
      }
      
      // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã‚’å¾©å…ƒ
      currentSegments.splice(insertIndex, 0, deletedItem.segment);
      
      // å±¥æ­´ã‚‚å¾©å…ƒ
      window.insertTMCrow(insertIndex, deletedItem.segment.text);
      if (deletedItem.history && deletedItem.history.length > 0) {
        window.TextMidChange[insertIndex] = [...deletedItem.history];
      }
      
      regenerateBtn.disabled = false;
      updateChangeNotice();
      renderSegmentsUI(currentSegments);
      updateVoiceFilterOptions();
      updateGlobalRedoButton(); // DPoolãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
      if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        tabBtns.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        tabContents.forEach(tc => tc.style.display = 'none');
        const target = document.getElementById(btn.dataset.tab);
        if (target) target.style.display = 'block';
      });
    });


    // ====== èª¬æ˜ã‚¿ãƒ–å†…å®¹ ======
    const descTab = document.getElementById('tab-desc');
    descTab.innerHTML = `
      <h2>KUSAIKOID ver.beta4.1</h2>
      <ul style="margin-left:1.2em;">
        <li>ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–‡ã”ã¨ã«åˆ†å‰²ã—ã€å„æ–‡ã”ã¨ã«å£°ã‚„å†…å®¹ã‚’ç·¨é›†ã§ãã¾ã™ã€‚</li>
        <li>ã€Œï¼‹ä¸Šã€ã€Œï¼‹ä¸‹ã€ã§æ–‡ã‚’è¿½åŠ ã€ã€ŒğŸ—‘ï¸ã€ã§å‰Šé™¤ã§ãã¾ã™ã€‚</li>
        <li>ç·¨é›†å¾Œã¯ã€Œç·¨é›†å¾Œã®MP3ã‚’å†ç”Ÿæˆã€ãƒœã‚¿ãƒ³ã§éŸ³å£°ã‚’å†å–å¾—ã—ã¦ãã ã•ã„ã€‚</li>
        <li>ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¯â‰¡ãƒœã‚¿ãƒ³ã€å³ä¸‹âš™ãƒœã‚¿ãƒ³ã§é–‹é–‰ã§ãã¾ã™ã€‚</li>
      </ul>
      <div style="margin-top:1.2em; color:#555;">
        <b>ä»Šå¾Œã®äºˆå®š:</b> ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ç™»éŒ²ã€éŸ³å£°åˆæˆã®è©³ç´°è¨­å®šãªã©ã‚’ã“ã“ã«è¿½åŠ å¯èƒ½ã§ã™ã€‚<br>
        UI/UXã®è¿½åŠ æ©Ÿèƒ½ã‚„ãƒ˜ãƒ«ãƒ—ã‚‚ã“ã®ã‚¨ãƒªã‚¢ã«é…ç½®ã§ãã¾ã™ã€‚
      </div>
    `;

    // ãƒ•ã‚£ãƒ«ã‚¿ã‚¿ãƒ–ã«ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
    const filterTab = document.getElementById('tab-filter');
    // éŸ³å£°åãƒªã‚¹ãƒˆï¼ˆvoiceSelectã‹ã‚‰å–å¾—ï¼‰
    const voiceSelectOptions = Array.from(defaultVoiceSelect.options).map(opt => ({ value: opt.value, label: opt.textContent }));

    // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆ
    const filterLabel = document.createElement('label');
    filterLabel.textContent = 'éŸ³å£°ãƒ•ã‚£ãƒ«ã‚¿:';
    filterLabel.style.marginRight = '0.5em';
    const filterSelect = document.createElement('select');
    filterSelect.style.minWidth = '160px';
    filterLabel.appendChild(filterSelect);
    filterTab.appendChild(filterLabel);

    // ç·¨é›†çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿è¿½åŠ 
    const editStateDiv = document.createElement('div');
    editStateDiv.style.marginTop = '1em';
    editStateDiv.style.marginBottom = '0.7em';
    const editStateLabel = document.createElement('label');
    editStateLabel.textContent = 'ç·¨é›†çŠ¶æ…‹:';
    editStateLabel.style.marginRight = '0.5em';
    const editStateSelect = document.createElement('select');
    editStateSelect.style.minWidth = '120px';
    [
      { value: '', label: 'ã™ã¹ã¦' },
      { value: 'false', label: 'æœªç·¨é›†' },
      { value: 'true', label: 'ç·¨é›†æ¸ˆã¿' }
    ].forEach(opt => {
      const o = document.createElement('option');
      o.value = opt.value;
      o.textContent = opt.label;
      editStateSelect.appendChild(o);
    });
    editStateLabel.appendChild(editStateSelect);
    editStateDiv.appendChild(editStateLabel);
    filterTab.appendChild(editStateDiv);

    // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹è¿½åŠ 
    const searchDiv = document.createElement('div');
    searchDiv.style.marginTop = '1em';
    const searchLabel = document.createElement('label');
    searchLabel.textContent = 'ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢:';
    searchLabel.style.marginRight = '0.5em';
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.placeholder = 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›';
    searchInput.style.minWidth = '160px';
    searchDiv.appendChild(searchLabel);
    searchDiv.appendChild(searchInput);
    filterTab.appendChild(searchDiv);

    // ä½¿ç”¨ä¸­ã®voiceã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ã‚»ãƒ¬ã‚¯ãƒˆã«è¡¨ç¤ºã™ã‚‹
    function updateVoiceFilterOptions() {
      // ç¾åœ¨ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã§ä½¿ã‚ã‚Œã¦ã„ã‚‹voiceã‚’é›†è¨ˆ
      const usedVoices = new Set();
      const segDivs = segmentsAudioList.querySelectorAll('.ttsbox');
      console.log('updateVoiceFilterOptions: found', segDivs.length, 'ttsboxes');
      segDivs.forEach((div, index) => {
        // selectãƒœãƒƒã‚¯ã‚¹ã®å®Ÿéš›ã®å€¤ã‚’å‚ç…§ï¼ˆå‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒæ§˜ï¼‰
        const select = div.querySelector('select');
        const voice = select ? select.value : '';
        console.log(`Segment ${index}: select.value="${voice}"`);
        if (voice) usedVoices.add(voice);
      });
      console.log('Used voices:', Array.from(usedVoices));
      console.log('Available voiceSelectOptions:', voiceSelectOptions);
      console.log('Current filter options before update:', Array.from(filterSelect.options).map(o => ({ value: o.value, text: o.textContent })));
      
      // é¸æŠè‚¢ã‚’å†æ§‹ç¯‰
      const prev = filterSelect.value;
      filterSelect.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = '';
      optAll.textContent = 'ã™ã¹ã¦';
      filterSelect.appendChild(optAll);
      
      let addedCount = 0;
      voiceSelectOptions.forEach(opt => {
        console.log(`Checking option: value="${opt.value}", label="${opt.label}", isUsed=${usedVoices.has(opt.value)}`);
        if (usedVoices.has(opt.value)) {
          const o = document.createElement('option');
          o.value = opt.value;
          o.textContent = opt.label;
          filterSelect.appendChild(o);
          addedCount++;
          console.log(`Added filter option: ${opt.label} (${opt.value})`);
        }
      });
      console.log(`Total filter options added: ${addedCount}`);
      console.log('Filter options after update:', Array.from(filterSelect.options).map(o => ({ value: o.value, text: o.textContent })));
      
      // ç›´å‰ã®é¸æŠå€¤ãŒæ®‹ã£ã¦ã„ã‚Œã°ç¶­æŒ
      if ([...filterSelect.options].some(o => o.value === prev)) {
        filterSelect.value = prev;
      } else {
        filterSelect.value = '';
      }
    }


    // ãƒ•ã‚£ãƒ«ã‚¿å‡¦ç†æœ¬ä½“ï¼ˆéŸ³å£°ãƒ•ã‚£ãƒ«ã‚¿ï¼‹ç·¨é›†çŠ¶æ…‹ï¼‹ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ï¼‰
    function applyVoiceFilter() {
      const voiceVal = filterSelect.value;
      const searchVal = searchInput.value.trim();
      const editStateVal = editStateSelect.value;
      // ttsboxå˜ä½ã§å‡¦ç†
      const segDivs = segmentsAudioList.querySelectorAll('.ttsbox');
      segDivs.forEach(div => {
        // selectãƒœãƒƒã‚¯ã‚¹ã®å®Ÿéš›ã®å€¤ã‚’å‚ç…§ï¼ˆå‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¨åŒæ§˜ï¼‰
        const voiceSelect = div.querySelector('select');
        const currentVoice = voiceSelect ? voiceSelect.value : '';
        // data-editedå±æ€§ã‚’å‚ç…§
        const dataEdited = div.dataset.edited || 'false';
        // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å€¤
        const textarea = div.querySelector('textarea');
        const textVal = textarea ? textarea.value : '';
        // éŸ³å£°ãƒ•ã‚£ãƒ«ã‚¿
        let visible = true;
        if (voiceVal && currentVoice !== voiceVal) visible = false;
        // ç·¨é›†çŠ¶æ…‹ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆdata-editedï¼‰
        if (editStateVal === 'true' && dataEdited !== 'true') visible = false;
        if (editStateVal === 'false' && dataEdited !== 'false') visible = false;
        // ãƒ†ã‚­ã‚¹ãƒˆæ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
        if (searchVal && !textVal.includes(searchVal)) visible = false;
        if (visible) {
          div.style.display = '';
          div.dataset.visible = 'true';
        } else {
          div.style.display = 'none';
          div.dataset.visible = 'false';
        }
      });
    }
    filterSelect.addEventListener('change', applyVoiceFilter);
    searchInput.addEventListener('input', applyVoiceFilter);
    editStateSelect.addEventListener('change', applyVoiceFilter);

    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆUIå†æç”»æ™‚ã«ã‚‚ãƒ•ã‚£ãƒ«ã‚¿é¸æŠè‚¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ã‚’å†é©ç”¨
    const _origRenderSegmentsUI = renderSegmentsUI;
    renderSegmentsUI = function(segmentsData) {
      _origRenderSegmentsUI(segmentsData);
      updateVoiceFilterOptions();
      applyVoiceFilter();
    };

    // MP3ç”Ÿæˆæ™‚ã«ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã€Œã™ã¹ã¦ã€ã«ãƒªã‚»ãƒƒãƒˆ
    const _origGenerateBtnHandler = generateBtn.onclick;
    generateBtn.addEventListener('click', () => {
      filterSelect.value = '';
      updateVoiceFilterOptions();
      applyVoiceFilter();
    });
  </script>
<!-- ====== TextMidChangeã®Excelé¢¨è¡Œæ“ä½œã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•° ====== -->
<script>
window.insertTMCrow = function(idx, fillText = '') {
  // Poolã«ã¯è¿½åŠ ä½ç½®ä»¥é™ã®è¡Œã ã‘ã‚’è¨˜æ†¶
  window._debugPool = window.TextMidChange.slice(idx).map(row => Array.isArray(row) ? [...row] : []);
  // è¿½åŠ è¡Œã‚’fillTextã§åŸ‹ã‚ã‚‹ï¼ˆ0ç•ªç›®ã®ã¿ã€1ã€œ9ç•ªç›®ã¯ç©ºï¼‰
  const newRow = [fillText, '', '', '', '', '', '', '', '', ''];
  // TextMidChangeã‚’å†æ§‹ç¯‰
  const upper = window.TextMidChange.slice(0, idx);
  const lower = window._debugPool;
  window.TextMidChange.length = 0;
  for (let i = 0; i < upper.length; i++) window.TextMidChange.push([...upper[i]]);
  window.TextMidChange.push(newRow);
  for (let i = 0; i < lower.length; i++) window.TextMidChange.push([...lower[i]]);
  if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
};

window.deleteTMCrow = function(idx) {
  window._debugPool = window.TextMidChange.map(row => Array.isArray(row) ? [...row] : []);
  const pool = window._debugPool;
  let newTextMidChange = [];
  const rowCount = pool.length;
  for (let i = 0; i < rowCount - 1; i++) {
    if (i < idx) {
      newTextMidChange[i] = [...pool[i]];
    } else {
      newTextMidChange[i] = [...pool[i + 1]];
    }
  }
  window.TextMidChange.length = 0;
  for (let i = 0; i < newTextMidChange.length; i++) {
    window.TextMidChange.push(newTextMidChange[i]);
  }
  if (window.updateDebugMenu && document.getElementById('debugMenuToggle')?.checked) window.updateDebugMenu();
};
</script>
</body>
</html>
