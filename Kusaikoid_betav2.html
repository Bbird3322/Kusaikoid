<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Kusaikoid(仮)</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    textarea, select { width: 100%; margin-bottom: 1em; padding: 0.5em; }
    button { padding: 0.5em 1em; margin-right: 0.5em; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .result { margin-top: 1em; word-break: break-word; }
    #segmentsAudioList > div {
      margin-bottom: 0.5em;
    }
  </style>
</head>
<body>
  <h1>Kusaikoid(仮)</h1>

  <label for="voiceSelect">声を選んでください:</label>
  <select id="voiceSelect">
    <option value="2">拓也さん / CV.SHOW</option>
    <option value="3">MISAKI</option>
    <option value="4">SAYAKA</option>
    <option value="5">HIKARI</option>
    <option value="6">マネージャー / CV.HARUKA</option>
    <option value="7">RYO</option>
    <option value="8">レオ / CV.TAKERU</option>
  </select>

  <label for="textInput">テキストを入力:</label>
  <textarea id="textInput" rows="5">拓也の射精3000円。</textarea>
  <div id="charCount">0文字</div>

  <div>
    <button id="generateBtn">MP3を生成</button>
    <button id="downloadBtn" disabled>MP3をダウンロード</button>
  </div>

  <div class="result" id="result"></div>
  <div id="segmentsAudioList"></div>

  <script>
    const generateBtn = document.getElementById('generateBtn');
    const textInput = document.getElementById('textInput');
    const charCount = document.getElementById('charCount');
    const resultDiv = document.getElementById('result');
    const downloadBtn = document.getElementById('downloadBtn');
    const segmentsAudioList = document.getElementById('segmentsAudioList');

    let audioBlobs = [];
    let finalBlobURL = null;

    textInput.addEventListener('input', () => {
      charCount.textContent = `${textInput.value.length}文字`;
    });
    charCount.textContent = `${textInput.value.length}文字`;

    function generateTTSURL(vid, text) {
      const sanitized = text.replace(/&/g, 'アンド').replace(/=/g, 'イコール');
      return `https://cache-a.oddcast.com/tts/genC.php?EID=3&LID=12&VID=${vid}&TXT=${encodeURIComponent(sanitized)}&EXT=mp3&FNAME=&ACC=15679&SceneID=2646118&HTTP_ERR=`;
    }

    // 200字超えたら句点(。)で分割しつつ、さらに細かく分割して200字以内に
    function splitTextByCommaAndLimit(text, limit = 200) {
      const sentences = text.split('。').map(s => s.trim()).filter(Boolean);
      const chunks = [];
      let currentChunk = '';
      for (const sentence of sentences) {
        if ((currentChunk + sentence + '。').length > limit) {
          if (currentChunk) chunks.push(currentChunk);
          if (sentence.length > limit) {
            // それでも長い場合はさらに細分化
            for(let i=0; i<sentence.length; i+=limit) {
              chunks.push(sentence.slice(i, i+limit));
            }
            currentChunk = '';
          } else {
            currentChunk = sentence + '。';
          }
        } else {
          currentChunk += sentence + '。';
        }
      }
      if (currentChunk) chunks.push(currentChunk);
      return chunks;
    }

    async function fetchMP3Blob(url) {
      const res = await fetch(url, { mode: 'cors' });
      if (!res.ok) throw new Error('音声ファイル取得に失敗しました');
      return await res.blob();
    }

    generateBtn.addEventListener('click', async () => {
      const rawText = textInput.value.trim();
      const vid = document.getElementById('voiceSelect').value;
      if (!rawText) {
        alert('テキストを入力してください');
        return;
      }

      resultDiv.textContent = '生成中...';
      segmentsAudioList.innerHTML = '';
      audioBlobs = [];
      if(finalBlobURL) {
        URL.revokeObjectURL(finalBlobURL);
        finalBlobURL = null;
      }
      downloadBtn.disabled = true;

      try {
        const segments = splitTextByCommaAndLimit(rawText, 200);

        for (const segment of segments) {
          const url = generateTTSURL(vid, segment);
          const blob = await fetchMP3Blob(url);
          audioBlobs.push(blob);

          // セグメント表示 + 音声プレーヤー
          const div = document.createElement('div');
          div.textContent = segment;
          const audio = document.createElement('audio');
          audio.controls = true;
          audio.src = URL.createObjectURL(blob);
          audio.style.marginLeft = '1em';
          div.appendChild(audio);
          segmentsAudioList.appendChild(div);
        }

        // 音声ファイル結合（単純にBlob連結）
        finalBlobURL = URL.createObjectURL(new Blob(audioBlobs, { type: 'audio/mp3' }));

        // まとめ再生用プレーヤー表示
        resultDiv.innerHTML = '';
        const audio = document.createElement('audio');
        audio.controls = true;
        audio.src = finalBlobURL;
        resultDiv.appendChild(audio);

        downloadBtn.disabled = false;

      } catch (e) {
        alert('音声生成でエラーが発生しました');
        console.error(e);
      }
    });

    downloadBtn.addEventListener('click', () => {
      if (!finalBlobURL) return;
      const a = document.createElement('a');
      a.href = finalBlobURL;
      a.download = 'merged_audio.mp3';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });
  </script>
</body>
</html>
